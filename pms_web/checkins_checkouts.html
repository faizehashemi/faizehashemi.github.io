<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="./logo.png">
    <title>Checkins</title>
    <style>
        :root {
            /* Cream • Gold • Brown palette */
            --ink: #1a0f0a; /* darkest brown for all text */
            --muted: #5e4a39; /* softer brown for secondary text */
            --card: #fffaf1; /* warm off-white panels */
            --border: #dcc7a4; /* soft cream-gold border */
            --accent: #d4af37; /* gold accent */
            --shadow: 0 10px 28px rgba(92,64,28,.12);
            --chip: #f7ecd1; /* pale gold chip hover/base */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Keep cream/brown vibe in dark mode, just deepen surfaces */
                --ink: #1a0f0a;
                --muted: #4a3a2d;
                --card: #f9f1e3;
                --border: #cdb492;
                --accent: #e0c457;
                --shadow: none;
                --chip: #f3e6ca;
            }
        }

        * {
            box-sizing: border-box
        }

        body {
            font: 14px/1.45 system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #f7efe1 url("./pattern_gold_2x.png") repeat;
            background-size: 150px auto;
            margin: 15px;
            color: var(--ink);
        }

        .wrap {
            max-width: 1500px;
            margin: 22px auto;
            padding: 0 14px 40px;
        }

        header.hero {
            background: linear-gradient(0deg, color-mix(in oklab, var(--accent) 18%, transparent) 0%, color-mix(in oklab, var(--accent) 10%, transparent) 100%);
            border-radius: 16px;
            padding: 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        h1 {
            margin: 0 0 6px
        }

        .muted {
            color: var(--muted)
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 10px;
            align-items: end;
            margin-top: 10px;
        }

            .controls .col {
                display: flex;
                flex-direction: column;
                gap: 6px
            }

            .controls .col-3 {
                grid-column: span 3
            }

            .controls .col-2 {
                grid-column: span 2
            }

            .controls .col-4 {
                grid-column: span 4
            }

        @media (max-width: 900px) {
            .controls {
                grid-template-columns: repeat(6, 1fr)
            }

                .controls .col-3 {
                    grid-column: span 3
                }

                .controls .col-2 {
                    grid-column: span 3
                }

                .controls .col-4 {
                    grid-column: span 6
                }
        }

        input[type="date"], input[type="time"], select, button {
            font: inherit
        }

        input[type="date"], input[type="time"], select {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
            background: #fffdf5;
            color: var(--ink);
        }

        button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--card);
            color: var(--ink);
            cursor: pointer;
            transition: background .15s ease, transform .08s ease;
        }

            button:hover {
                background: #fff6dd
            }

            button:active {
                transform: translateY(1px)
            }

            button.primary {
                border-color: color-mix(in oklab, var(--accent) 55%, #fff);
                background: linear-gradient(0deg, color-mix(in oklab, var(--accent) 20%, transparent) 0%, color-mix(in oklab, var(--accent) 12%, transparent) 100%), var(--card);
            }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .chip {
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 13px;
            color: var(--ink);
            cursor: pointer;
            transition: background .15s ease;
        }

            .chip:hover {
                background: var(--chip)
            }

        .grid {
            display: grid;
            gap: 12px;
            margin-top: 14px
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            box-shadow: var(--shadow);
        }

            .panel h3 {
                margin: 0 0 6px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                color: var(--ink);
            }

            .panel .toolbar {
                display: flex;
                gap: 8px;
                align-items: center
            }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fffdf7
        }

        th, td {
            border: 1px solid var(--border);
            padding: 8px;
            vertical-align: middle;
            color: var(--ink);
            text-align: center;
        }

        th {
            background: color-mix(in oklab, var(--accent) 14%, #fff8e6);
            text-align: center;
        }

        .right {
            text-align: right
        }

        .nowrap {
            white-space: nowrap
        }

        .status {
            margin-top: 8px;
            color: var(--muted)
        }

        @media print {
            body {
                margin: 0
            }

                body * {
                    visibility: hidden !important
                }

            .print-scope, .print-scope * {
                visibility: visible !important;
            }

            .print-scope {
                position: absolute;
                inset: 0;
                margin: 0;
            }
        }

        .btn-open {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--card);
            color: var(--ink);
            text-decoration: none;
            transition: background .15s ease, transform .08s ease;
        }

            .btn-open:hover {
                background: #fff6dd
            }

            .btn-open:active {
                transform: translateY(1px)
            }

            .btn-open[aria-disabled="true"] {
                opacity: .5;
                pointer-events: none;
            }
    </style>

</head>
<body>

    <!-- Navbar --> <site-nav></site-nav>
    <script type="module" src="./site-nav.js"></script>

    <div class="wrap">
        <header class="hero">
            <h1>Check-ins & Check-outs</h1>
            <p class="muted">Filter by single day or a date/time range. Results are read-only and pulled from your local IndexedDB.</p>

            <div class="controls">
                <div class="col col-3">
                    <label for="dateFrom" class="muted">Date from</label>
                    <input id="dateFrom" type="date">
                </div>
                <div class="col col-3">
                    <label for="dateTo" class="muted">Date to</label>
                    <input id="dateTo" type="date">
                </div>
                <div class="col col-2">
                    <label for="timeFrom" class="muted">Time from</label>
                    <input id="timeFrom" type="time" step="60" value="03:00">
                </div>
                <div class="col col-2">
                    <label for="timeTo" class="muted">Time to</label>
                    <input id="timeTo" type="time" step="60" value="03:00">
                </div>
                <div class="col col-2">
                    <label for="mode" class="muted">Mode</label>
                    <select id="mode">
                        <option value="both">Both</option>
                        <option value="in">Check-ins</option>
                        <option value="out">Check-outs</option>
                    </select>
                </div>
                <div class="col col-4">
                    <label class="muted">Quick</label>
                    <div class="chips">
                        <button class="chip" id="presetToday">Today</button>
                        <button class="chip" id="presetYesterday">Yesterday</button>
                        <button class="chip" id="preset7">Last 7 days</button>
                        <button class="chip" id="preset30">Last 30 days</button>
                    </div>
                </div>
                <div class="col col-4">
                    <label class="muted">Actions</label>
                    <div class="chips">
                        <button id="btnRefresh">Refresh DB</button>
                        <button id="btnRun" class="primary">Run</button>
                    </div>
                </div>
            </div>
        </header>

        <section class="grid">
            <div class="panel" id="panelIn" hidden>
                <h3>
                    <span>Check-ins</span>
                    <span class="toolbar">
                        <span class="muted" id="sumIn">0 slips • 0 guests</span>
                        <button id="csvIn">Export CSV</button>
                        <button id="printIn">Print table</button>
                    </span>

                </h3>
                <table id="tblIn">
                    <thead>
                        <tr>
                            <th class="nowrap">Check-in</th>
                            <th>SH No</th>
                            <th>Group</th>
                            <th>Group Leader</th>
                            <th>Building</th>
                            <th>Rooms</th>
                            <th>As.</th>
                            <th>T</th>
                            <th>G</th>
                            <th>L</th>
                            <th>C</th>
                            <th>I</th>
                            <th class="nowrap">Check-out</th>
                            <th class="nowrap">Slip</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="panel" id="panelOut" hidden>
                <h3>
                    <span>Check-outs</span>
                    <span class="toolbar">
                        <span class="muted" id="sumOut">0 slips • 0 guests</span>
                        <button id="csvOut">Export CSV</button>
                        <button id="printOut">Print table</button>
                    </span>

                </h3>
                <table id="tblOut">
                    <thead>
                        <tr>
                            <th class="nowrap">Check-out</th>
                            <th>SH No</th>
                            <th>Group</th>
                            <th>Group Leader</th>
                            <th>Building</th>
                            <th>Rooms</th>
                            <th>As.</th>
                            <th>T</th>
                            <th>G</th>
                            <th>L</th>
                            <th>C</th>
                            <th>I</th>
                            <th class="nowrap">Check-in</th>
                            <th class="nowrap">Slip</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <p class="status" id="status">Loading DB…</p>
    </div>

    <script>
    /* ===== DB plumbing ===== */
const DB_NAME = 'pms_accommodation_db';
const STORE = 'slips';

// Return a small dummy DB-like object so existing callers that check
// db.objectStoreNames.contains(STORE) keep behaving without changes.
function openExistingDB(name) {
  return new Promise((resolve) => {
    const fakeDb = {
      objectStoreNames: { contains: (s) => String(s) === STORE },
      close: () => {}
    };
    resolve(fakeDb);
  });
}

async function getAllRecords() {
  const RAW_GIST = 'https://gist.githubusercontent.com/faizehashemi/4d98eb35d2f88b099a1eb099a510dfed/raw';
  let db;
  try {
    db = await openExistingDB(DB_NAME);
    if (!db || !db.objectStoreNames || typeof db.objectStoreNames.contains !== 'function') {
      throw new Error('IndexedDB compatibility object not available');
    }
    if (!db.objectStoreNames.contains(STORE)) {
      db.close && db.close();
      throw new Error('Object store "' + STORE + '" not found');
    }

    const resp = await fetch(RAW_GIST + '?cb=' + Date.now(), { cache: 'no-store' });
    if (!resp.ok) {
      const err = new Error('Failed to fetch slips from gist: ' + resp.status + ' ' + resp.statusText);
      db.close && db.close();
      throw err;
    }

    const payload = await resp.json();

    // normalize shapes:
    // - raw array []
    // - { slips: [...] }
    // - { db: { stores: { slips: { rows: [...] } } } }
    let slips = [];
    if (Array.isArray(payload)) {
      slips = payload;
    } else if (Array.isArray(payload.slips)) {
      slips = payload.slips;
    } else {
      slips = payload?.db?.stores?.slips?.rows || [];
    }

    db.close && db.close();
    return slips;
  } catch (err) {
    try { db && db.close && db.close(); } catch (_) {}
    console.error('getAllSlips():', err);
    throw err;
  }
}

        /* ===== Helpers ===== */
        function $(id) { return document.getElementById(id) }
        function pad(n) { return String(n).padStart(2, '0') }
        function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
        function parseDT(d, t) { if (!d) return null; const tt = t && t.length ? t : '00:00'; const v = new Date(`${d}T${tt}`); return isNaN(v) ? null : v; }
        function ymd(d) { return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}` }
        function roomsFromSlip(r) { const bag = []; (r.rooms?.gents || []).forEach(x => bag.push(String(x.room_no || '').trim())); (r.rooms?.ladies || []).forEach(x => bag.push(String(x.room_no || '').trim())); return Array.from(new Set(bag.filter(Boolean))); }
        function guests(r) { const tot = n(r.total); if (tot) return tot; const kids = n(r.children ?? r.child); const inf = n(r.infants ?? r.infant); return n(r.gents) + n(r.ladies) + kids + inf; }
        function nights(r) { const ci = parseDT(r.checkin_date, r.checkin_time), co = parseDT(r.checkout_date, r.checkout_time); if (!ci || !co) return ''; const ms = co - ci; return Math.max(0, Math.round(ms / 86400000)); }
        function fmtDT(dt) { if (!dt) return ''; try { return dt.toLocaleString([], { year: '2-digit', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) } catch (e) { return dt.toISOString().slice(0, 16).replace('T', ' ') } }
        function within(dt, start, end) { return dt && dt >= start && dt <= end; }

        // NEW: robust Assigned calculation for your data shape
        function assignedCount(r){
            // Priority 1: explicit numeric fields if present
            const direct = r.assigned ?? r.assigned_count ?? r.assignedGuests ?? r.assignedRoomsCount;
            const directNum = Number(direct);
            if (Number.isFinite(directNum) && directNum >= 0) return directNum;

            // Priority 2: if rooms key exists, sum per-room `assigned` for both gents and ladies
            if (r.rooms && (Array.isArray(r.rooms.gents) || Array.isArray(r.rooms.ladies))){
                const sumAssigned = (arr) => (Array.isArray(arr) ? arr.reduce((s,x)=> s + (Number(x?.assigned) || 0), 0) : 0);
                const g = sumAssigned(r.rooms.gents);
                const l = sumAssigned(r.rooms.ladies);
                return g + l; // if rooms exist, show exactly what has been assigned in rooms
            }

            // Priority 3: no room-level assignment available at all -> fallback to headcount
            const kids = n(r.children ?? r.child);
            const inf = n(r.infants ?? r.infant);
            const tot = n(r.total) || (n(r.gents) + n(r.ladies) + kids + inf);
            return tot;
        }

            // Priority 3: fall back to headcount totals when no room-level assignment is available
            const n = v => { const x = Number(v); return Number.isFinite(x) ? x : 0; };
            const kids = n(r.children ?? r.child);
            const inf = n(r.infants ?? r.infant);
            const tot = n(r.total) || (n(r.gents) + n(r.ladies) + kids + inf);
            return tot;
        }

        let CACHE = [];

        /* ===== Render ===== */
        function run() {
            const df = $('dateFrom').value, dt = $('dateTo').value;
            const tf = $('timeFrom').value || '00:00', tt = $('timeTo').value || '23:59';
            if (!df || !dt) { alert('Pick both Date from and Date to.'); return; }
            const start = new Date(`${df}T${tf}`);
            let end = new Date(`${dt}T${tt}`);
            if (!(end > start)) end = new Date(start.getTime() + 24 * 60 * 60 * 1000);

            const mode = $('mode').value;

            const ins = [], outs = [];
            for (const r of CACHE) {
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                if (ci && within(ci, start, end)) ins.push(r);
                if (co && within(co, start, end)) outs.push(r);
            }

            ins.sort((a, b) => parseDT(a.checkin_date, a.checkin_time) - parseDT(b.checkin_date, b.checkin_time));
            outs.sort((a, b) => parseDT(a.checkout_date, a.checkout_time) - parseDT(b.checkout_date, b.checkout_time));

            renderTable('In', ins, 'checkin');
            renderTable('Out', outs, 'checkout');

            $('panelIn').hidden = !(mode === 'in' || mode === 'both');
            $('panelOut').hidden = !(mode === 'out' || mode === 'both');

            const totalGuestsIn = ins.reduce((s, r) => s + guests(r), 0);
            const totalGuestsOut = outs.reduce((s, r) => s + guests(r), 0);
            $('sumIn').textContent = `${ins.length} slips • ${totalGuestsIn} guests`;
            $('sumOut').textContent = `${outs.length} slips • ${totalGuestsOut} guests`;

            $('status').textContent = `Range ${df} ${tf} → ${dt} ${tt} • ${CACHE.length} slip(s) in DB`;
        }

        function renderTable(kind, rows, key) {
            const tbody = $(`tbl${kind}`).querySelector('tbody');
            tbody.innerHTML = '';
            for (const r of rows) {
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                const t = key === 'checkin' ? fmtDT(ci) : fmtDT(co);

                const sh = String(r.sh_no || '').trim();
                const href = sh ? `accommodation_slip.html?sh_no=${encodeURIComponent(sh)}` : `accommodation_slip.html`;
                const gl = (r.group_leader && String(r.group_leader).trim()) ? r.group_leader : 'unassigned';

                const openCell = sh
                    ? `<a class="btn-open" href="${href}" target="_blank" rel="noopener">Open</a>`
                    : `<a class="btn-open" aria-disabled="true" title="No SH number">Open</a>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
      <td class="nowrap">${t}</td>
      <td>${escapeHTML(r.sh_no || '')}</td>
      <td>${escapeHTML(r.tour_name || '')}</td>
      <td>${escapeHTML(gl)}</td>
      <td>${escapeHTML((r.building || '').trim())}</td>
      <td>${escapeHTML(roomsFromSlip(r).join(', '))}</td>
      <td>${assignedCount(r)}</td>
      <td>${guests(r)}</td>
      <td>${n(r.gents)}</td>
      <td>${n(r.ladies)}</td>
      <td>${n(r.children ?? r.child)}</td>
      <td>${n(r.infants ?? r.infant)}</td>
      <td class="nowrap">${key === 'checkin' ? fmtDT(co) : fmtDT(ci)}</td>
      <td class="nowrap">${openCell}</td>
    `;
                tbody.appendChild(tr);
            }
        }

        function escapeHTML(s) { return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])) }

        /* ===== CSV export ===== */
        function toCSV(rows, kind) {
            // align CSV with table headers: Rooms → As. → T → G → L → C → I
            const head = kind === 'in'
                ? ['Check-in','SH No','Group','Group Leader','Building','Rooms','As.','T','G','L','C','I','Check-out']
                : ['Check-out','SH No','Group','Group Leader','Building','Rooms','As.','T','G','L','C','I','Check-in'];

            const sep = ',';
            const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
            const lines = [head.join(sep)];

            for (const r of rows) {
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                const gl = (r.group_leader && String(r.group_leader).trim()) ? r.group_leader : 'unassigned';

                const row = kind === 'in'
                    ? [fmtDT(ci), r.sh_no || '', r.tour_name || '', gl, (r.building || '').trim(),
                       roomsFromSlip(r).join(' '), assignedCount(r), guests(r),
                       n(r.gents), n(r.ladies), n(r.children ?? r.child), n(r.infants ?? r.infant),
                       fmtDT(co)]
                    : [fmtDT(co), r.sh_no || '', r.tour_name || '', gl, (r.building || '').trim(),
                       roomsFromSlip(r).join(' '), assignedCount(r), guests(r),
                       n(r.gents), n(r.ladies), n(r.children ?? r.child), n(r.infants ?? r.infant),
                       fmtDT(ci)];

                lines.push(row.map(esc).join(sep));
            }
            return lines.join('\r\n');
        }

        function downloadCSV(text, filename) {
            const blob = new Blob([text], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        function printTableOnly(tableId) {
            const el = document.getElementById(tableId);
            if (!el) return alert('Table not found.');
            el.classList.add('print-scope');
            const cleanup = () => { el.classList.remove('print-scope'); window.removeEventListener('afterprint', cleanup); };
            window.addEventListener('afterprint', cleanup);
            setTimeout(() => window.print(), 0);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const btnIn = document.getElementById('printIn');
            const btnOut = document.getElementById('printOut');
            btnIn && btnIn.addEventListener('click', () => printTableOnly('tblIn'));
            btnOut && btnOut.addEventListener('click', () => printTableOnly('tblOut'));
        });

        /* ===== Boot ===== */
        async function refresh() {
            try {
                CACHE = await getAllRecords();
                const now = new Date();
                const today = ymd(now);
                $('dateFrom').value = today;
                $('dateTo').value = today;
                $('timeFrom').value = '03:00';
                $('timeTo').value = '03:00';
                run();
            } catch (e) {
                console.error(e);
                $('status').textContent = 'Could not open local DB (IndexedDB blocked?).';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            $('btnRefresh').addEventListener('click', refresh);
            $('btnRun').addEventListener('click', run);
            $('presetToday').addEventListener('click', () => {
                const now = new Date(); const t = ymd(now);
                $('dateFrom').value = t; $('dateTo').value = t;
                $('timeFrom').value = '03:00'; $('timeTo').value = '03:00';
                run();
            });
            $('presetYesterday').addEventListener('click', () => {
                const d = new Date(); d.setDate(d.getDate() - 1); const y = ymd(d);
                $('dateFrom').value = y; $('dateTo').value = y;
                $('timeFrom').value = '03:00'; $('timeTo').value = '03:00';
                run();
            });
            $('preset7').addEventListener('click', () => {
                const d = new Date(); const to = ymd(d); d.setDate(d.getDate() - 6);
                $('dateFrom').value = ymd(d); $('dateTo').value = to;
                $('timeFrom').value = '03:00'; $('timeTo').value = '03:00';
                run();
            });
            $('preset30').addEventListener('click', () => {
                const d = new Date(); const to = ymd(d); d.setDate(d.getDate() - 29);
                $('dateFrom').value = ymd(d); $('dateTo').value = to;
                $('timeFrom').value = '03:00'; $('timeTo').value = '03:00';
                run();
            });

            $('csvIn').addEventListener('click', () => {
                const df = $('dateFrom').value, dt = $('dateTo').value, tf = $('timeFrom').value || '00:00', tt = $('timeTo').value || '23:59';
                const start = new Date(`${df}T${tf}`), end = new Date(`${dt}T${tt}`);
                const rows = CACHE.filter(r => { const ci = parseDT(r.checkin_date, r.checkin_time); return ci && ci >= start && ci <= end; }).sort((a, b) => parseDT(a.checkin_date, a.checkin_time) - parseDT(b.checkin_date, b.checkin_time));
                downloadCSV(toCSV(rows, 'in'), `checkins_${df}_${dt}.csv`);
            });
            $('csvOut').addEventListener('click', () => {
                const df = $('dateFrom').value, dt = $('dateTo').value, tf = $('timeFrom').value || '00:00', tt = $('timeTo').value || '23:59';
                const start = new Date(`${df}T${tf}`), end = new Date(`${dt}T${tt}`);
                const rows = CACHE.filter(r => { const co = parseDT(r.checkout_date, r.checkout_time); return co && co >= start && co <= end; }).sort((a, b) => parseDT(a.checkout_date, a.checkout_time) - parseDT(b.checkout_date, b.checkout_time));
                downloadCSV(toCSV(rows, 'out'), `checkouts_${df}_${dt}.csv`);
            });
            refresh();
        });
    </script>

    <script>
        /* ===== Auto "Date To = Date From + 1" wiring, 3am defaults, preset integration ===== */
        (function () {
            const $ = id => document.getElementById(id);
            const pad = n => String(n).padStart(2, "0");
            const ymd = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

            function plusOneDay(yyyy_mm_dd) {
                if (!yyyy_mm_dd) return "";
                const [y, m, d] = yyyy_mm_dd.split("-").map(Number);
                const dt = new Date(y, (m || 1) - 1, d || 1);
                dt.setDate(dt.getDate() + 1);
                return ymd(dt);
            }

            let userEditedDateTo = false;
            let lastAutoTo = "";

            function haveInputs() { return $('#dateFrom') && $('#dateTo') && $('#timeFrom') && $('#timeTo'); }

            function applyDefaults() {
                const now = new Date();
                const df = ymd(now);
                const dt = plusOneDay(df);
                $('#dateFrom').value = $('#dateFrom').value || df;
                $('#dateTo').value = $('#dateTo').value || dt;
                $('#timeFrom').value = $('#timeFrom').value || '03:00';
                $('#timeTo').value = $('#timeTo').value || '03:00';
                lastAutoTo = $('#dateTo').value;
                userEditedDateTo = false;
            }

            function wireAutoTo() {
                $('#dateFrom').addEventListener('input', () => {
                    const df = $('#dateFrom').value;
                    if (!df) return;
                    if (!userEditedDateTo || $('#dateTo').value === lastAutoTo) {
                        const next = plusOneDay(df);
                        $('#dateTo').value = next;
                        lastAutoTo = next;
                        userEditedDateTo = false;
                    }
                });
                $('#dateTo').addEventListener('input', () => { userEditedDateTo = true; });
            }

            function ensureDateRange() {
                const df = $('#dateFrom').value;
                if (!$('#dateTo').value && df) {
                    $('#dateTo').value = plusOneDay(df);
                    lastAutoTo = $('#dateTo').value;
                    userEditedDateTo = false;
                }
                const tf = $('#timeFrom').value || '03:00';
                const tt = $('#timeTo').value || '03:00';
                const start = df ? new Date(`${df}T${tf}`) : null;
                const dt = $('#dateTo').value;
                let end = dt ? new Date(`${dt}T${tt}`) : null;

                if (start && end && !(end > start)) {
                    end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
                    $('#dateTo').value = ymd(end);
                    $('#timeTo').value = pad(end.getHours()) + ":" + pad(end.getMinutes());
                    lastAutoTo = $('#dateTo').value;
                    userEditedDateTo = false;
                }
                return { start, end };
            }

            function wirePresets() {
                const setRange = (df, dt) => {
                    $('#dateFrom').value = df;
                    $('#dateTo').value = dt;
                    $('#timeFrom').value = '03:00';
                    $('#timeTo').value = '03:00';
                    lastAutoTo = dt; userEditedDateTo = false;
                    ensureDateRange();
                    if (typeof window.run === 'function') window.run();
                };

                $('#presetToday')?.addEventListener('click', () => {
                    const d = new Date(); const df = ymd(d);
                    setRange(df, plusOneDay(df));
                });

                $('#presetYesterday')?.addEventListener('click', () => {
                    const d = new Date(); d.setDate(d.getDate() - 1);
                    const df = ymd(d);
                    setRange(df, plusOneDay(df));
                });

                $('#preset7')?.addEventListener('click', () => {
                    const end = new Date();
                    const start = new Date(); start.setDate(end.getDate() - 6);
                    setRange(ymd(start), plusOneDay(ymd(end)));
                });

                $('#preset30')?.addEventListener('click', () => {
                    const end = new Date();
                    const start = new Date(); start.setDate(end.getDate() - 29);
                    setRange(ymd(start), plusOneDay(ymd(end)));
                });
            }

            function patchRun() {
                if (typeof window.run !== 'function') return;
                const orig = window.run;
                window.run = function patchedRun(...args) {
                    ensureDateRange();
                    return orig.apply(this, args);
                };
            }

            function start() {
                if (!haveInputs()) return;
                applyDefaults();
                wireAutoTo();
                wirePresets();
                patchRun();
                ensureDateRange();
                if (typeof window.run === 'function') window.run();
            }

            if (document.readyState === 'complete' || document.readyState === 'interactive') start();
            else document.addEventListener('DOMContentLoaded', start);

            window.plusOneDay = plusOneDay;
        })();
    </script>

</body>
</html>
