<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Groups (Fixed v4)</title>
    <style>
        :root {
            --ink: #1a0f0a;
            --muted: #5e4a39;
            --bg: #f7efe1;
            --card: #fffaf1;
            --border: #dcc7a4;
            --accent: #d4af37;
        }

        * {
            box-sizing: border-box
        }

        body {
            font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background: var(--bg);
            margin: 15px;
            color: var(--ink);
        }

        .wrap {
            max-width: 1200px;
            margin: 20px auto;
            padding: 16px;
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(92,64,28,.12);
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-bottom: 4px;
        }

        input, button, select {
            font: inherit;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fffdf5;
            color: var(--ink);
        }

        button {
            cursor: pointer;
            transition: background .15s ease, transform .08s ease
        }

            button:hover {
                background: #fff6dd
            }

            button:active {
                transform: translateY(1px)
            }

            button.primary {
                background: var(--accent);
                border-color: var(--accent);
                color: #2b1e15;
            }

            button.ghost {
                background: #fffdf5
            }

        .grid {
            margin-top: 12px;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            font-size: 14px;
            color: var(--ink);
            vertical-align: top;
        }

        th {
            font-weight: 700;
            white-space: nowrap;
            background: #f3e6ca;
        }

        .tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .pill {
            display: inline-block;
            padding: 2px 8px;
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted);
            background: #fffaf1;
        }

        /* Print sizing */
        @page {
            size: A4 landscape;
            margin: 8mm
        }

        @media print {
            body {
                background: #fff
            }

            .no-print {
                display: none !important
            }

            .sticker {
                page-break-after: always
            }

                .sticker:last-child {
                    page-break-after: auto
                }
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        @media (max-width: 1000px) {
            .two-col {
                grid-template-columns: 1fr
            }
        }

        /* ================= Stickers ================= */
        .printable {
            display: block
        }

        .sticker {
            width: 100%;
            height: 185mm;
            margin: 0 auto 8mm;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px dashed var(--border);
            border-radius: 12px;
            background: #fffdf7;
            color: var(--ink);
            position: relative;
            overflow: hidden;
            padding: 6mm;
        }

            .sticker .fit {
                display: inline-block;
                transform-origin: center center;
                max-width: 95%;
                will-change: transform;
            }

        .fit.hidden {
            visibility: hidden
        }

        /* Shared pair layout */
        .pair {
            display: block;
            margin: 0 0 8px;
        }

        .tour-big {
            font-weight: 800;
            line-height: 1.06;
            margin: 6px 0 0;
        }

        .count {
            font-weight: 700;
            letter-spacing: .5px;
            margin-left: .25em;
            opacity: .85;
        }

        .leader-small {
            font-weight: 700;
            line-height: 1.05;
            margin: 4px 0 0;
            opacity: .9;
        }

        /* Sticker typography */
        .sticker .tour-big {
            font-size: 86px;
        }

        .sticker .count {
            font-size: 0.45em;
        }

        .sticker .leader-small {
            font-size: 40px;
        }

        .pax {
            font-size: 28px;
            margin-top: 12px;
            letter-spacing: .5px;
        }

        /* Assignment table visuals (compact, aligned) */
        #assignTbl {
            table-layout: fixed;
        }

            #assignTbl col.w-pick {
                width: 44px
            }

            #assignTbl col.w-pair {
                width: auto
            }

            #assignTbl col.w-pax {
                width: 130px
            }

            #assignTbl col.w-tools {
                width: 180px
            }

        .assign-cell {
            font-size: 14px;
        }

        .assign-pair .tour-big {
            font-size: 20px;
            line-height: 1.15;
            margin: 2px 0 0;
        }

        .assign-pair .count {
            font-size: .8em
        }

        .assign-pair .leader-small {
            font-size: 13px;
            margin: 0 0 6px
        }

        input.pax {
            width: 100%;
            max-width: 110px;
            font-size: 14px;
            padding: 6px 8px;
        }

        .btn-row button {
            margin-right: 6px
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="panel no-print">
            <div class="row">
                <div><label for="dateFrom">Arrivals from</label><input id="dateFrom" type="date"></div>
                <div><label for="dateTo">Arrivals to</label><input id="dateTo" type="date"></div>
                <div><label for="timeFrom">Time from</label><input id="timeFrom" type="time"></div>
                <div><label for="timeTo">Time to</label><input id="timeTo" type="time"></div>
                <div><label for="building">Building</label><input id="building" type="text" placeholder="exact match or blank"></div>
                <div class="tools"><button id="btnSearch" class="primary">Load arrivals</button><span class="pill" id="foundInfo">0 found</span></div>
            </div>
            <div class="grid" id="resultsWrap" style="display:none">
                <table id="resultsTbl" aria-label="Arrivals">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selAll"></th>
                            <th>Tour Name</th>
                            <th>Leader</th>
                            <th>SH</th>
                            <th>Check-in</th>
                            <th>Building</th>
                            <th>Total</th>
                            <th>Add</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="tools" id="resultsTools" style="display:none">
                <button id="btnAddSelected">Add selected</button>
                <button id="btnBundleSelected" title="Bundle selected arrivals">Bundle selected</button>
            </div>
        </div>

        <div class="two-col">
            <div class="panel no-print">
                <div class="grid">
                    <table id="assignTbl" aria-label="Assignment list">
                        <colgroup>
                            <col class="w-pick" />
                            <col class="w-pair" />
                            <col class="w-pax" />
                            <col class="w-tools" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="assignAll"></th>
                                <th>Tour & Leader</th>
                                <th>Pax limit</th>
                                <th>Tools</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="tools btn-row">
                    <button id="btnSplit" title="Split one selected slot">Split selected</button>
                    <button id="btnBundleSlots" title="Bundle selected slots">Bundle selected</button>
                    <button id="btnClearList" class="ghost">Clear</button>
                    <button id="btnPrint" class="primary">Print stickers</button>
                </div>
            </div>

            <div class="panel"><div id="stickers" class="printable"></div></div>
        </div>
    </div>

    <script>
        /* ========= Data plumbing (read-only gist) ========= */
        const DB_NAME = 'pms_accommodation_db';
        const STORE = 'slips';
        function openExistingDB() {
            return Promise.resolve({ objectStoreNames: { contains: (s) => String(s) === STORE }, close: () => { } });
        }
        async function getAllSlips() {
            const RAW_GIST = 'https://gist.githubusercontent.com/faizehashemi/4d98eb35d2f88b099a1eb099a510dfed/raw';
            let db; try {
                db = await openExistingDB(DB_NAME);
                if (!db.objectStoreNames.contains(STORE)) throw new Error('Object store missing');
                const resp = await fetch(RAW_GIST + '?cb=' + Date.now(), { cache: 'no-store' });
                if (!resp.ok) throw new Error('Fetch failed ' + resp.status);
                const payload = await resp.json();
                let slips = [];
                if (Array.isArray(payload)) slips = payload;
                else if (Array.isArray(payload.slips)) slips = payload.slips;
                else slips = payload?.db?.stores?.slips?.rows || [];
                return slips;
            } finally { try { db && db.close() } catch { } }
        }

        /* ========= Helpers ========= */
        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));
        const pad2 = n => String(n).padStart(2, '0');
        const normalize = s => (s == null ? '' : String(s)).trim();
        const uniq = a => Array.from(new Set(a));
        const sum = a => a.reduce((x, y) => x + Number(y || 0), 0);
        function toDateObj(dstr, tstr) { if (!dstr) return null; const [y, m, d] = dstr.split('-').map(Number); let hh = 0, mm = 0; if (tstr && /^\d{1,2}:\d{2}$/.test(tstr)) { [hh, mm] = tstr.split(':').map(Number) }; return new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0, 0, 0) }
        function esc(s) { return String(s == null ? '' : s).replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c])) }
        function sentenceCase(str) { const s = normalize(str).toLowerCase(); return s ? s.charAt(0).toUpperCase() + s.slice(1) : '' }

        /* ========= State ========= */
        let ALL = [], RESULTS = [], ASSIGN = [], idCounter = 1;

        function makeSlot(fromItems) {
            const tours = fromItems.map(it => ({
                tour_name: normalize(it.tour_name),
                group_leader: normalize(it.group_leader),
                sh: normalize(it.sh_no),
                total: Number(it.total || 0)
            }));
            return { id: 'S' + (idCounter++), tours, pax: sum(fromItems.map(it => Number(it.total || 0))) || fromItems.length };
        }

        // Aggregate by tour+leader with per-pair counts; skip empty rows entirely
        function pairAgg(slot) {
            const map = new Map();
            for (const t of slot.tours) {
                const tour = normalize(t.tour_name); const leader = normalize(t.group_leader);
                if (!tour && !leader) continue; // drop garbage rows
                const key = tour + '|' + leader;
                if (!map.has(key)) map.set(key, { tour_name: tour, group_leader: leader, count: 0 });
                const add = Number.isFinite(Number(t.total)) && Number(t.total) > 0 ? Number(t.total) : 1;
                map.get(key).count += add;
            }
            return Array.from(map.values());
        }

        /* ========= Renderers ========= */
        function renderResults() {
            const tbody = $('#resultsTbl tbody'); tbody.innerHTML = '';
            $('#foundInfo').textContent = `${RESULTS.length} found`;
            $('#resultsWrap').style.display = RESULTS.length ? '' : 'none';
            $('#resultsTools').style.display = RESULTS.length ? '' : 'none';
            for (const r of RESULTS) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td><input type="checkbox" class="sel"></td>
            <td>${esc(r.tour_name || '')}</td>
            <td>${esc(r.group_leader || '')}</td>
            <td>${esc(r.sh_no || '')}</td>
            <td>${esc(r.checkin_date || '')} <span class="small">${esc(r.checkin_time || '')}</span></td>
            <td>${esc(r.building || '')}</td>
            <td>${Number(r.total || 0)}</td>
            <td><button class="ghost add">Add</button></td>`;
                tr.querySelector('.add').addEventListener('click', () => { ASSIGN.push(makeSlot([r])); renderAssign(); });
                tbody.appendChild(tr);
            }
            const selAll = $('#selAll'); selAll.checked = false; selAll.onchange = () => $$('#resultsTbl tbody .sel').forEach(cb => cb.checked = selAll.checked);
        }

        function renderAssign() {
            const tbody = $('#assignTbl tbody'); tbody.innerHTML = '';
            for (const s of ASSIGN) {
                const pairs = pairAgg(s).map(p => {
                    const leader = sentenceCase(p.group_leader);
                    const leaderLine = leader ? `<div class="leader-small">${esc(leader)}</div>` : '';
                    return `<div class="pair assign-pair">
              <div class="tour-big">${esc(p.tour_name)} <span class="count">(${Number(p.count || 0)})</span></div>
              ${leaderLine}
            </div>`;
                }).join('');
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td><input type="checkbox" class="pick"></td>
            <td class="assign-cell">${pairs}</td>
            <td><input type="number" min="0" value="${Number(s.pax || 0)}" class="pax"></td>
            <td class="tools"><button class="ghost split">Split</button><button class="ghost remove">Remove</button></td>`;
                tr.querySelector('.pax').addEventListener('change', e => { s.pax = Math.max(0, Number(e.target.value || 0)); renderStickers(); });
                tr.querySelector('.split').addEventListener('click', () => {
                    const tot = Number(s.pax || 0); const a = prompt(`Split slot (Total ${tot}). Enter first half pax:`, Math.floor(tot / 2)); if (a == null) return;
                    const aNum = Math.max(0, Number(a || 0)); const bNum = Math.max(0, tot - aNum);
                    const slot1 = { id: 'S' + (idCounter++), tours: JSON.parse(JSON.stringify(s.tours)), pax: aNum };
                    const slot2 = { id: 'S' + (idCounter++), tours: JSON.parse(JSON.stringify(s.tours)), pax: bNum };
                    ASSIGN = ASSIGN.filter(x => x !== s).concat([slot1, slot2]); renderAssign();
                });
                tr.querySelector('.remove').addEventListener('click', () => { ASSIGN = ASSIGN.filter(x => x !== s); renderAssign(); });
                tbody.appendChild(tr);
            }
            const sel = $('#assignAll'); sel.checked = false; sel.onchange = () => $$('#assignTbl tbody .pick').forEach(cb => cb.checked = sel.checked);
            renderStickers();
        }

        function renderStickers() {
            const cont = $('#stickers'); cont.innerHTML = '';
            for (const s of ASSIGN) {
                const div = document.createElement('div'); div.className = 'sticker';
                const pairs = pairAgg(s);
                const title = pairs.map(p => {
                    const leader = sentenceCase(p.group_leader);
                    const leaderLine = leader ? `<div class="leader-small">${esc(leader)}</div>` : '';
                    return `<div class="pair">
              <div class="tour-big">${esc(p.tour_name)} <span class="count">(${Number(p.count || 0)})</span></div>
              ${leaderLine}
            </div>`;
                }).join('');
                const fit = document.createElement('div');
                fit.className = 'fit hidden';
                fit.innerHTML = `<div class="tour">${title}</div><div class="pax">PAX LIMIT: <strong>${Number(s.pax || 0)}</strong></div>`;
                div.appendChild(fit);
                cont.appendChild(div);
            }
            requestAnimationFrame(() => { fitAllStickers(true); requestAnimationFrame(() => fitAllStickers(true)); });
        }

        /* ========= Fit logic (robust first-page fix) ========= */
        function fitAllStickers(forceVisible) {
            const stickers = $$('#stickers .sticker');
            for (const st of stickers) {
                const fit = st.querySelector('.fit'); if (!fit) continue;
                fit.style.transform = 'scale(1)';
                const w = st.clientWidth, h = st.clientHeight; const bw = fit.scrollWidth, bh = fit.scrollHeight; if (!w || !h || !bw || !bh) continue;
                let scale = Math.min(w / (bw + 2), h / (bh + 2)); if (!isFinite(scale) || scale <= 0) scale = 1; scale = Math.min(1, scale * 0.985);
                fit.style.transform = `scale(${scale})`;
                if (forceVisible) fit.classList.remove('hidden');
            }
        }

        // Refit on font readiness, load, resize, DOM changes, and before print
        (function setupFitHooks() {
            if (document.fonts && document.fonts.ready) { document.fonts.ready.then(() => { fitAllStickers(true); setTimeout(() => fitAllStickers(true), 50); }); }
            window.addEventListener('load', () => { fitAllStickers(true); setTimeout(() => fitAllStickers(true), 50); });
            window.addEventListener('resize', () => { fitAllStickers(true); });
            const obs = new MutationObserver(() => { requestAnimationFrame(() => fitAllStickers(true)); });
            obs.observe($('#stickers'), { childList: true, subtree: true });

            function beforePrint() { fitAllStickers(true); setTimeout(() => fitAllStickers(true), 50); }
            if ('onbeforeprint' in window) window.addEventListener('beforeprint', beforePrint);
            else if (window.matchMedia) {
                const mql = window.matchMedia('print');
                try { mql.addEventListener('change', e => { if (e.matches) beforePrint(); }); }
                catch { mql.addListener(e => { if (e.matches) beforePrint(); }); }
            }
        })();

        /* ========= Actions ========= */
        $('#btnSearch').addEventListener('click', async () => {
            if (!ALL.length) ALL = await getAllSlips();
            const df = $('#dateFrom').value, dt = $('#dateTo').value; if (!df || !dt) { alert('Pick a date range.'); return; }
            const tf = $('#timeFrom').value || '00:00', tt = $('#timeTo').value || '23:59'; const b = normalize($('#building').value);
            const start = toDateObj(df, tf), end = toDateObj(dt, tt);
            const inRange = s => { const d = toDateObj(s.checkin_date, s.checkin_time); return d && d >= start && d <= end };
            RESULTS = ALL.filter(s => inRange(s)).filter(s => !b || normalize(s.building) === b).map(s => ({
                tour_name: s.tour_name || '', group_leader: s.group_leader || '', sh_no: s.sh_no || '', checkin_date: s.checkin_date || '', checkin_time: s.checkin_time || '', building: s.building || '', total: Number(s.total || 0)
            })).sort((a, b) => (a.checkin_date + a.checkin_time).localeCompare(b.checkin_date + b.checkin_time));
            renderResults();
        });

        $('#btnAddSelected').addEventListener('click', () => {
            const rows = $$('#resultsTbl tbody tr');
            const chosen = rows.filter(r => r.querySelector('.sel').checked).map(tr => { const td = tr.children; return { tour_name: td[1].textContent.trim(), group_leader: td[2].textContent.trim(), sh_no: td[3].textContent.trim(), total: Number(td[6].textContent.trim() || 0) } });
            if (!chosen.length) { alert('Select arrivals first.'); return; }
            chosen.forEach(c => ASSIGN.push(makeSlot([c]))); renderAssign();
        });

        $('#btnBundleSelected').addEventListener('click', () => {
            const rows = $$('#resultsTbl tbody tr');
            const chosen = rows.filter(r => r.querySelector('.sel').checked).map(tr => { const td = tr.children; return { tour_name: td[1].textContent.trim(), group_leader: td[2].textContent.trim(), sh_no: td[3].textContent.trim(), total: Number(td[6].textContent.trim() || 0) } });
            if (chosen.length < 2) { alert('Select at least two arrivals to bundle.'); return; }
            ASSIGN.push(makeSlot(chosen)); renderAssign();
        });

        $('#btnSplit').addEventListener('click', () => {
            const rows = $$('#assignTbl tbody tr'); const picks = rows.filter(r => r.querySelector('.pick').checked); if (picks.length !== 1) { alert('Pick exactly one slot to split.'); return; }
            const idx = rows.indexOf(picks[0]); const slot = ASSIGN[idx]; const tot = Number(slot.pax || 0); const a = prompt(`Split slot (Total ${tot}). Enter first half pax:`, Math.floor(tot / 2)); if (a == null) return;
            const aNum = Math.max(0, Number(a || 0)); const bNum = Math.max(0, tot - aNum); const slot1 = { id: 'S' + (idCounter++), tours: JSON.parse(JSON.stringify(slot.tours)), pax: aNum }; const slot2 = { id: 'S' + (idCounter++), tours: JSON.parse(JSON.stringify(slot.tours)), pax: bNum }; ASSIGN.splice(idx, 1, slot1, slot2); renderAssign();
        });

        $('#btnBundleSlots').addEventListener('click', () => {
            const rows = $$('#assignTbl tbody tr'); const picks = rows.map((r, i) => ({ row: r, idx: i })).filter(p => p.row.querySelector('.pick').checked); if (picks.length < 2) { alert('Pick at least two slots to bundle.'); return; }
            const items = picks.map(p => ASSIGN[p.idx]); const merged = { id: 'S' + (idCounter++), tours: items.flatMap(s => s.tours), pax: sum(items.map(s => s.pax || 0)) };
            picks.sort((a, b) => b.idx - a.idx).forEach(p => ASSIGN.splice(p.idx, 1)); ASSIGN.push(merged); renderAssign();
        });

        $('#btnClearList').addEventListener('click', () => { if (confirm('Clear the assignment list?')) { ASSIGN = []; renderAssign(); } });
        $('#btnPrint').addEventListener('click', () => {
            // Ensure a stable two-pass fit before triggering the print dialog
            fitAllStickers(true);
            setTimeout(() => { fitAllStickers(true); window.print(); }, 80);
        });

        (function initDefaults() { const now = new Date(); const yyyy = now.getFullYear(), mm = pad2(now.getMonth() + 1), dd = pad2(now.getDate()); $('#dateFrom').value = `${yyyy}-${mm}-${dd}`; $('#dateTo').value = `${yyyy}-${mm}-${dd}`; })();
    </script>
</body>
</html>
