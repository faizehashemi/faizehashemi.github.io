<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Print Slip — A5 Landscape (2-up, multi)</title>
    <style>
        :root {
            --ink: #000;
            --muted: #444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f3f3f3;
            margin: 0;
            color: var(--ink);
        }

        .wrap {
            max-width: 1500px;
            margin: 18px auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            background: #ffffff url("./pattern_gold_2x.png") repeat;
            background-size: 150px auto; /* larger tile = calmer page */
        }

        h1 {
            margin: 4px 0 10px;
            text-align: center;
            font-size: 18px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: end;
            justify-content: space-between;
            margin-bottom: 10px;
        }

            .controls > div {
                display: flex;
                gap: 8px;
                align-items: center;
            }

        label {
            font-size: 12px;
            color: var(--muted);
        }

        select, input, button, textarea {
            font: inherit;
            border: 1px solid #bbb;
            border-radius: 8px;
            padding: 7px 10px;
            background: #fff;
        }

        textarea {
            width: 280px;
            height: 38px;
            resize: vertical
        }

        button {
            cursor: pointer;
        }

            button:hover {
                background: #f1f1f1;
            }

        .status {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        /* Page layout: a "sheet" holds two slips (2-up) for ONE record */
        .sheet {
            display: flex;
            gap: 6mm;
        }

        .slip {
            flex: 1 1 0;
            border: 1px solid #000;
            padding: 2mm;
        }

        .title {
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: .3px;
            border-bottom: 1px solid #000;
            padding: 1mm 0 1.5mm;
            margin-bottom: 1.5mm;
            text-transform: uppercase;
        }

        table.grid {
            width: 100%;
            border-collapse: collapse;
        }

            table.grid th, table.grid td {
                border: 1px solid #000;
                padding: 1.2mm 1.6mm;
                font-size: 11px;
                vertical-align: middle;
            }

            table.grid th {
                font-weight: 700;
                text-align: left;
                white-space: nowrap;
            }

        .pair th {
            width: 28%;
        }

        .pair td[colspan="3"] {
            width: auto;
        }

        .muted {
            color: var(--muted);
        }

        /* Force center alignment in all slip tables */
        table.grid th,
        table.grid td,
        .mini th,
        .mini td {
            text-align: center !important;
        }

        .subtables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2mm;
            margin-top: 2mm;
        }

        .mini caption {
            caption-side: top;
            text-align: left;
            font-weight: 700;
            font-size: 11px;
            margin-bottom: 1mm;
        }

        .mini {
            width: 100%;
            border-collapse: collapse;
        }

            .mini th, .mini td {
                border: 1px solid #000;
                padding: 1.2mm 1.6mm;
                font-size: 11px;
            }

            .mini th {
                text-align: left;
            }

        /* Print rules */
        @page {
            size: A5 landscape;
            margin: 6mm;
        }

        @media print {
            body {
                background: #fff;
            }

            .wrap, .controls, .status, h1 {
                display: none !important;
            }

            .printable {
                display: block !important;
            }

                .printable .sheet {
                    break-inside: avoid;
                    page-break-after: always;
                }

                    .printable .sheet:last-child {
                        page-break-after: auto;
                    }
        }
        /* On-screen preview container (hidden in print) */
        .printable {
            display: block;
        }

        .note {
            font-size: 11px;
            color: var(--muted);
            margin-top: 6px;
        }
    </style>

    <!-- libs for export to JPEG+ZIP -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

</head>
<body>

    <div class="wrap">
        <!-- Navbar --> <site-nav></site-nav>
        <script type="module" src="/components/site-nav.js"></script>

        <h1>Print Slip — A5 Landscape (2 copies per slip)</h1>
        <div class="controls">
            <div>
                <label for="savedList">Saved slips</label>
                <select id="savedList" title="Saved slips" style="min-width:320px;"></select>
                <button id="btnLoad">Load</button>
            </div>
            <div>
                <label for="shFetch">SH No(s)</label>
                <textarea id="shFetch" placeholder="e.g. 38480, 39221 39222-39223 39224*39225&#10;Separators: comma, dot, dash, space, newline, asterisk"></textarea>
                <button id="btnFetch">Fetch list</button>
            </div>
            <div>
                <label for="rows">Rows</label>
                <input id="rows" type="number" min="4" max="12" value="8" style="width:70px" />
                <button id="btnPrint">Print</button>
                <button id="btnExportZip" title="Export one JPEG per slip in a ZIP">Export JPEGs (ZIP)</button>
            </div>
        </div>
        <div class="note">Use the SH multi-field to fetch multiple slips. Each slip prints on its own page.</div>
        <div class="status" id="status">Loading DB…</div>
    </div>

    <!-- Live preview / print content -->
    <div class="printable" id="printArea">
        <div id="sheet"><!-- multiple .sheet blocks injected here --></div>
    </div>

    <script>
    /* ===== DB v2 plumbing ===== */
    const DB_NAME = 'pms_accommodation_db';
    const STORE = 'slips';
    const DB_VERSION = 2;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          let s;
          if (!db.objectStoreNames.contains(STORE)) {
            s = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
          } else {
            s = e.target.transaction.objectStore(STORE);
          }
          if (!s.indexNames.contains('createdAt')) s.createIndex('createdAt', 'createdAt', { unique: false });
          if (!s.indexNames.contains('sh_no')) s.createIndex('sh_no', 'sh_no', { unique: false });
          if (!s.indexNames.contains('building')) s.createIndex('building', 'building', { unique: false });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function getAllRecords() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readonly');
        const st = tx.objectStore(STORE);
        const rq = st.getAll();
        rq.onsuccess = () => resolve(rq.result || []);
        rq.onerror = () => reject(rq.error);
        tx.oncomplete = () => db.close();
      });
    }

    /* Flexible latest-by-sh using in-memory cache, tolerant to string/number */
    function latestByShFromCache(cache, sh) {
      const key = String(sh).trim();
      const list = cache.filter(r => r && r.sh_no != null && String(r.sh_no).trim() === key);
      if (!list.length) return null;
      return list.sort((a,b) => (a.createdAt > b.createdAt ? -1 : 1))[0];
    }

    /* ===== UI helpers ===== */
    function $(id) { return document.getElementById(id); }
    let CACHE = [];
    /** CURRENT is an array of selected slip records */
    let CURRENT = [];

    function ymdToDMY(ymd) {
      if (!ymd) return '';
      const [y, m, d] = ymd.split('-');
      return `${d}/${m}/${y}`;
    }
    function hhmmToHMS(hhmm) {
      if (!hhmm) return '';
      const [h, m] = hhmm.split(':');
      return `${h}:${m}:00`;
    }

    function parseShList(text){
      if(!text) return [];
      return Array.from(new Set(text.split(/[,\.\-\s\*]+/).map(s=>s.trim()).filter(Boolean)));
    }

    /* Build the slip HTML for one copy */
    function slipHTML(rec, rows) {
      const title = 'ACCOMODATION DETAILS'; // matches the screenshot spelling
      const ciDate = ymdToDMY(rec.checkin_date || '');
      const coDate = ymdToDMY(rec.checkout_date || '');
      const ciTime = hhmmToHMS(rec.checkin_time || '');
      const coTime = hhmmToHMS(rec.checkout_time || '');

      const gents = (rec.rooms?.gents || []).slice(0, rows);
      const ladies = (rec.rooms?.ladies || []).slice(0, rows);

      function fillRows(arr) {
        const out = [];
        for (let i = 0; i < rows; i++) {
          const r = arr[i];
          const room = r && r.room_no ? r.room_no : '-';
          // prefer assigned, otherwise capacity, otherwise 0
          const beds = r && (r.assigned !== '' && r.assigned != null)
            ? r.assigned
            : (r && (r.capacity !== '' && r.capacity != null) ? r.capacity : 0);
          out.push(`<tr><td>${room}</td><td>${beds}</td></tr>`);
        }
        return out.join('');
      }

      return `
      <div class="slip">
        <div class="title">${title}</div>
        <table class="grid pair">
          <tbody>
            <tr>
              <th>TOUR NAME</th>
              <td colspan="3">${rec.tour_name || ''}</td>
            </tr>
            <tr>
              <th>GRP LEADER</th>
              <td colspan="3">${rec.group_leader || ''}</td>
            </tr>
            <tr>
              <th>CHECK IN</th>
              <td>${ciDate}</td>
              <td>${ciTime}</td>
              <td></td>
            </tr>
            <tr>
              <th>CHECK OUT</th>
              <td>${coDate}</td>
              <td>${coTime}</td>
              <td></td>
            </tr>
            <tr>
              <th>BUILDING</th>
              <td colspan="3">${rec.building || ''}</td>
            </tr>
            <tr>
              <th>SH NO.</th>
              <td>${rec.sh_no ?? ''}</td>
              <th>TOTAL</th>
              <td>${rec.total ?? ''}</td>
            </tr>
            <tr>
              <th>GENTS</th>
              <td>${rec.gents ?? ''}</td>
              <th>LADIES</th>
              <td>${rec.ladies ?? ''}</td>
            </tr>
            <tr>
              <th>CHILDREN</th>
              <td>${rec.children ?? ''}</td>
              <th>INFANTS</th>
              <td>${rec.infants ?? ''}</td>
            </tr>
          </tbody>
        </table>

        <div class="subtables">
          <table class="mini">
            <caption>GENTS</caption>
            <thead>
              <tr><th>Room No</th><th>Assigned Beds</th></tr>
            </thead>
            <tbody>
              ${fillRows(gents)}
            </tbody>
          </table>

          <table class="mini">
            <caption>LADIES</caption>
            <thead>
              <tr><th>Room No</th><th>Assigned Beds</th></tr>
            </thead>
            <tbody>
              ${fillRows(ladies)}
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function renderSlips() {
      const area = $('sheet');
      area.innerHTML = '';
      const rows = Math.max(4, Math.min(12, Number($('rows').value || 8)));
      const arr = Array.isArray(CURRENT) ? CURRENT : (CURRENT ? [CURRENT] : []);
      if (!arr.length) {
        area.insertAdjacentHTML('beforeend',
          `<div class="sheet" data-sh="">
             <div class="slip"><div class="title">ACCOMODATION DETAILS</div>
               <div style="padding:4mm; font-size:11px;">No slip loaded.</div>
             </div>
             <div class="slip"><div class="title">ACCOMODATION DETAILS</div>
               <div style="padding:4mm; font-size:11px;">No slip loaded.</div>
             </div>
           </div>`);
        return;
      }
      for (const rec of arr) {
        const block = document.createElement('div');
        block.className = 'sheet';
        block.setAttribute('data-sh', rec.sh_no ?? '');
        block.insertAdjacentHTML('beforeend', slipHTML(rec, rows));
        block.insertAdjacentHTML('beforeend', slipHTML(rec, rows));
        area.appendChild(block);
      }
    }

    /* Populate dropdown */
    async function refreshList() {
      CACHE = await getAllRecords();
      const list = $('savedList');
      list.innerHTML = '';
      if (!CACHE.length) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = 'No slips found';
        list.appendChild(opt);
      } else {
        const sorted = [...CACHE].sort((a, b) => (a.createdAt > b.createdAt ? -1 : 1));
        for (const r of sorted) {
          const when = new Date(r.createdAt).toLocaleString();
          const name = r.tour_name || '(unnamed tour)';
          const sh = r.sh_no ?? '';
          const o = document.createElement('option');
          o.value = r.id;
          o.textContent = `#${r.id} — ${name}${sh !== '' ? ' — SH ' + sh : ''} — ${when}`;
          list.appendChild(o);
        }
      }
      $('status').textContent = `${CACHE.length} slip(s) in DB. Load or fetch to preview.`;
    }

    /* Wire events */
    $('btnLoad').addEventListener('click', () => {
      const id = Number($('savedList').value);
      const rec = CACHE.find(x => x.id === id);
      if (!rec) { alert('Select a valid slip.'); return; }
      CURRENT = [rec];
      renderSlips();
      $('status').textContent = `Loaded #${rec.id}${rec.sh_no ? ' (SH ' + rec.sh_no + ')' : ''}`;
    });

    $('btnFetch').addEventListener('click', async () => {
      const raw = $('shFetch').value || '';
      const tokens = parseShList(raw);
      if (!tokens.length) { alert('Enter one or more SH numbers.'); return; }
      // make sure cache is loaded
      if (!CACHE.length) CACHE = await getAllRecords();
      const found = [];
      const missed = [];
      for (const t of tokens) {
        const rec = latestByShFromCache(CACHE, t);
        if (rec) found.push(rec); else missed.push(t);
      }
      CURRENT = found;
      renderSlips();
      const msg = `Fetched ${found.length}/${tokens.length} slip(s)` + (missed.length ? `. Missing: ${missed.join(', ')}` : '');
      $('status').textContent = msg;
    });

    $('shFetch').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && (e.ctrlKey || e.metaKey || !e.shiftKey)){
        e.preventDefault(); $('btnFetch').click();
      }
    });

    $('rows').addEventListener('change', renderSlips);
    $('btnPrint').addEventListener('click', () => window.print());

    // Export each rendered SHEET to JPEG and zip them
    $('btnExportZip').addEventListener('click', async ()=>{
      const sheets = Array.from(document.querySelectorAll('#sheet .sheet'));
      if (!sheets.length) { alert('Nothing to export. Fetch or load slips first.'); return; }
      const zip = new JSZip();
      let i = 1;
      for (const el of sheets) {
        // ensure white background for canvas
        const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff' });
        const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
        const b64 = dataUrl.split(',')[1];
        const sh = (el.getAttribute('data-sh') || '').toString().trim();
        const name = sh ? `slip_SH_${sh}.jpg` : `slip_${String(i).padStart(2,'0')}.jpg`;
        zip.file(name, b64, { base64: true });
        i++;
      }
      const blob = await zip.generateAsync({ type:'blob' });
      const stamp = new Date().toISOString().slice(0,10);
      saveAs(blob, `slips_${stamp}.zip`);
    });

    /* Boot */
    (async function init() {
      await refreshList();
      renderSlips();
    })();
    </script>
</body>
</html>
