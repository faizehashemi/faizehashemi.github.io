<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Print — GL Copy (v4)</title>
    <style>
        :root {
            --ink: #111;
            --muted: #555;
            --border: #111
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f6f6f6;
            margin: 0;
            color: var(--ink)
        }

        .wrap {
            max-width: 1500px;
            margin: 18px auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            background: #ffffff
        }

        h1 {
            margin: 4px 0 10px;
            text-align: center;
            font-size: 18px
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: end;
            justify-content: space-between;
            margin-bottom: 10px
        }

            .controls > div {
                display: flex;
                gap: 8px;
                align-items: center
            }

        label {
            font-size: 12px;
            color: var(--muted)
        }

        select, input, button, textarea {
            font: inherit;
            border: 1px solid #bbb;
            border-radius: 8px;
            padding: 7px 10px;
            background: #fff
        }

        textarea {
            width: 280px;
            height: 38px;
            resize: vertical
        }

        button {
            cursor: pointer
        }

            button:hover {
                background: #f1f1f1
            }

        .status {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px
        }

        /* Sheet holds two slips (2-up) */
        .sheet {
            display: flex;
            gap: 6mm
        }

        /* Slip uses theme variables for color */
        .slip {
            flex: 1 1 0;
            border: 1px solid var(--border);
            padding: 2mm;
            color: var(--ink)
        }

        .title {
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: .3px;
            border-bottom: 1px solid var(--border);
            padding: 1mm 0 1.5mm;
            margin-bottom: 1.5mm;
            text-transform: uppercase;
            color: var(--ink)
        }

        table.grid {
            width: 100%;
            border-collapse: collapse;
            color: var(--ink)
        }

            table.grid th, table.grid td {
                border: 1px solid var(--border);
                padding: 1.2mm 1.6mm;
                font-size: 11px;
                vertical-align: middle
            }

            table.grid th {
                font-weight: 700;
                text-align: left;
                white-space: nowrap
            }

        .pair th {
            width: 28%
        }

        .pair td[colspan="3"] {
            width: auto
        }

        .muted {
            color: var(--muted)
        }

        /* Force center alignment in all slip tables */
        table.grid th, table.grid td, .mini th, .mini td {
            text-align: center !important
        }

        .subtables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2mm;
            margin-top: 2mm
        }

        .mini caption {
            caption-side: top;
            text-align: left;
            font-weight: 700;
            font-size: 11px;
            margin-bottom: 1mm;
            color: var(--ink)
        }

        .mini {
            width: 100%;
            border-collapse: collapse;
            color: var(--ink)
        }

            .mini th, .mini td {
                border: 1px solid var(--border);
                padding: 1.2mm 1.6mm;
                font-size: 11px
            }

            .mini th {
                text-align: left
            }

        /* Print rules */
        @page {
            size: A5 landscape;
            margin: 6mm
        }

        @media print {
            body {
                background: #fff
            }

            .wrap, .controls, .status, h1 {
                display: none !important
            }

            .printable {
                display: block !important
            }

                .printable .sheet {
                    break-inside: avoid;
                    page-break-after: always
                }

                    .printable .sheet:last-child {
                        page-break-after: auto
                    }
        }

        .printable {
            display: block
        }

        .note {
            font-size: 11px;
            color: var(--muted);
            margin-top: 6px
        }

        /* ==================== THEMES (GL Copy) ==================== */
        /* When .gl-mode is present on #printArea, any .slip with a theme-* class uses that color */
        #printArea.gl-mode .theme-mohammedi {
            --ink: #d35400;
            --border: #d35400
        }
        /* Orange */
        #printArea.gl-mode .theme-mufaddal {
            --ink: #e91e63;
            --border: #e91e63
        }
        /* Pink */
        #printArea.gl-mode .theme-snood {
            --ink: #000000;
            --border: #000000
        }
        /* Black */
        #printArea.gl-mode .theme-baha {
            --ink: #2ecc71;
            --border: #2ecc71
        }
        /* Light Green */
    </style>

    <!-- libs kept (present in original) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="wrap">
        <site-nav></site-nav>
        <script type="module" src="./site-nav.js"></script>

        <h1>Print Slip — A5 Landscape (2 copies per slip)</h1>
        <div class="controls">
            <div>
                <label for="savedList">Saved slips</label>
                <select id="savedList" title="Saved slips" style="min-width:320px;"></select>
                <button id="btnLoad">Load</button>
            </div>
            <div>
                <label for="shFetch">SH No(s)</label>
                <textarea id="shFetch" placeholder="e.g. 38480, 39221 39222-39223 39224*39225&#10;Separators: comma, dot, dash, space, newline, asterisk"></textarea>
                <button id="btnFetch">Fetch list</button>
            </div>
            <div>
                <label for="rows">Rows</label>
                <input id="rows" type="number" min="4" max="12" value="8" style="width:70px" />
                <button id="btnPrint">Print</button>
                <button id="btnGLCopy" title="Print Group Leader copy with building-based colour-coding">GL Copy</button>
            </div>
        </div>
        <div class="note">Use the SH multi-field to fetch multiple slips. Each slip prints on its own page.</div>
        <div class="status" id="status">Loading DB…</div>
    </div>

    <div class="printable" id="printArea">
        <div id="sheet"><!-- multiple .sheet blocks injected here --></div>
    </div>

    <script>
        /* ===== DB v2 plumbing (unchanged) ===== */
        const DB_NAME = 'pms_accommodation_db';
        const STORE = 'slips';
        const DB_VERSION = 2;
        function openDB() { return new Promise((resolve, reject) => { const req = indexedDB.open(DB_NAME, DB_VERSION); req.onupgradeneeded = (e) => { const db = e.target.result; let s; if (!db.objectStoreNames.contains(STORE)) { s = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true }); } else { s = e.target.transaction.objectStore(STORE); } if (!s.indexNames.contains('createdAt')) s.createIndex('createdAt', 'createdAt', { unique: false }); if (!s.indexNames.contains('sh_no')) s.createIndex('sh_no', 'sh_no', { unique: false }); if (!s.indexNames.contains('building')) s.createIndex('building', 'building', { unique: false }); }; req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); }
        async function getAllRecords() { const db = await openDB(); return new Promise((resolve, reject) => { const tx = db.transaction(STORE, 'readonly'); const st = tx.objectStore(STORE); const rq = st.getAll(); rq.onsuccess = () => resolve(rq.result || []); rq.onerror = () => reject(rq.error); tx.oncomplete = () => db.close(); }); }

        /* ===== Helpers ===== */
        function $(id) { return document.getElementById(id) }
        let CACHE = []; let CURRENT = []; // array of selected records
        function ymdToDMY(ymd) { if (!ymd) return ''; const [y, m, d] = ymd.split('-'); return `${d}/${m}/${y}` }
        function hhmmToHMS(hhmm) { if (!hhmm) return ''; const [h, m] = hhmm.split(':'); return `${h}:${m}:00` }
        function parseShList(text) { if (!text) return []; return Array.from(new Set(text.split(/[,.\-\s\*]+/).map(s => s.trim()).filter(Boolean))) }

        // Theme mapping by BUILDING text (not leader)
        function themeForBuilding(rec) {
            const src = (rec.building || '').toString().toUpperCase();
            if (src.includes('MOHAMMEDI')) return 'theme-mohammedi';
            if (src.includes('MUFADDAL')) return 'theme-mufaddal';
            if (src.includes('SNOOD')) return 'theme-snood';
            if (src.includes('BAHA')) return 'theme-baha';
            return 'theme-snood'; // default: black
        }

        /* Build the slip HTML for one copy */
        function slipHTML(rec, rows) {
            const title = 'ACCOMODATION DETAILS';
            const ciDate = ymdToDMY(rec.checkin_date || '');
            const coDate = ymdToDMY(rec.checkout_date || '');
            const ciTime = hhmmToHMS(rec.checkin_time || '');
            const coTime = hhmmToHMS(rec.checkout_time || '');

            const gents = (rec.rooms?.gents || []).slice(0, rows);
            const ladies = (rec.rooms?.ladies || []).slice(0, rows);

            function fillRows(arr) {
                const out = []; for (let i = 0; i < rows; i++) { const r = arr[i]; const room = r && r.room_no ? r.room_no : '-'; const beds = r && (r.assigned !== '' && r.assigned != null) ? r.assigned : (r && (r.capacity !== '' && r.capacity != null) ? r.capacity : 0); out.push(`<tr><td>${room}</td><td>${beds}</td></tr>`); } return out.join('')
            }

            return `
            <div class="slip" data-rec-id="${rec.id}">
              <div class="title">${title}</div>
              <table class="grid pair">
                <tbody>
                  <tr>
                    <th>TOUR NAME</th>
                    <td colspan="3">${rec.tour_name || ''}</td>
                  </tr>
                  <tr>
                    <th>GRP LEADER</th>
                    <td colspan="3">${rec.group_leader || ''}</td>
                  </tr>
                  <tr>
                    <th>CHECK IN</th>
                    <td>${ciDate}</td>
                    <td>${ciTime}</td>
                    <td></td>
                  </tr>
                  <tr>
                    <th>CHECK OUT</th>
                    <td>${coDate}</td>
                    <td>${coTime}</td>
                    <td></td>
                  </tr>
                  <tr>
                    <th>BUILDING</th>
                    <td colspan="3">${rec.building || ''}</td>
                  </tr>
                  <tr>
                    <th>SH NO.</th>
                    <td>${rec.sh_no ?? ''}</td>
                    <th>TOTAL</th>
                    <td>${rec.total ?? ''}</td>
                  </tr>
                  <tr>
                    <th>GENTS</th>
                    <td>${rec.gents ?? ''}</td>
                    <th>LADIES</th>
                    <td>${rec.ladies ?? ''}</td>
                  </tr>
                  <tr>
                    <th>CHILDREN</th>
                    <td>${rec.children ?? ''}</td>
                    <th>INFANTS</th>
                    <td>${rec.infants ?? ''}</td>
                  </tr>
                </tbody>
              </table>

              <div class="subtables">
                <table class="mini">
                  <caption>GENTS</caption>
                  <thead><tr><th>Room No</th><th>Assigned Beds</th></tr></thead>
                  <tbody>${fillRows(gents)}</tbody>
                </table>
                <table class="mini">
                  <caption>LADIES</caption>
                  <thead><tr><th>Room No</th><th>Assigned Beds</th></tr></thead>
                  <tbody>${fillRows(ladies)}</tbody>
                </table>
              </div>
            </div>`;
        }

        function renderSlips() {
            const area = $('sheet'); area.innerHTML = '';
            const rows = Math.max(4, Math.min(12, Number($('rows').value || 8)));
            const arr = Array.isArray(CURRENT) ? CURRENT : (CURRENT ? [CURRENT] : []);
            if (!arr.length) {
                area.insertAdjacentHTML('beforeend', `<div class="sheet" data-sh=""><div class="slip" data-rec-id=""><div class="title">ACCOMODATION DETAILS</div><div style="padding:4mm; font-size:11px;">No slip loaded.</div></div><div class="slip" data-rec-id=""><div class="title">ACCOMODATION DETAILS</div><div style="padding:4mm; font-size:11px;">No slip loaded.</div></div></div>`);
                return;
            }
            for (const rec of arr) {
                const block = document.createElement('div');
                block.className = 'sheet';
                block.setAttribute('data-sh', rec.sh_no ?? '');
                // two copies per sheet
                block.insertAdjacentHTML('beforeend', slipHTML(rec, rows));
                block.insertAdjacentHTML('beforeend', slipHTML(rec, rows));
                area.appendChild(block);
            }
        }

        /* Populate dropdown */
        async function refreshList() {
            CACHE = await getAllRecords(); const list = $('savedList'); list.innerHTML = '';
            if (!CACHE.length) { const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'No slips found'; list.appendChild(opt); }
            else { const sorted = [...CACHE].sort((a, b) => (a.createdAt > b.createdAt ? -1 : 1)); for (const r of sorted) { const when = new Date(r.createdAt).toLocaleString(); const name = r.tour_name || '(unnamed tour)'; const sh = r.sh_no ?? ''; const o = document.createElement('option'); o.value = r.id; o.textContent = `#${r.id} — ${name}${sh !== '' ? ' — SH ' + sh : ''} — ${when}`; list.appendChild(o); } }
            $('status').textContent = `${CACHE.length} slip(s) in DB. Load or fetch to preview.`;
        }

        /* ===== GL Copy theming (per Building) ===== */
        let GL_MODE_ACTIVE = false;

        function clearThemes() {
            $('printArea').classList.remove('gl-mode');
            document.querySelectorAll('.slip').forEach(el => {
                if (el.dataset.classBackup) { el.className = el.dataset.classBackup; delete el.dataset.classBackup; }
                else {
                    // remove any theme-* class without clobbering other classes
                    el.className = el.className.replace(/\btheme-(mohammedi|mufaddal|snood|baha)\b/g, '').replace(/\s{2,}/g, ' ').trim();
                }
            });
        }

        function applyThemesForGL() {
            const area = $('printArea');
            area.classList.add('gl-mode');
            const all = document.querySelectorAll('.slip');
            for (const el of all) {
                if (!el.dataset.classBackup) el.dataset.classBackup = el.className;
                const id = Number(el.getAttribute('data-rec-id') || '');
                const rec = CACHE.find(x => x.id === id) || CURRENT.find(x => x.id === id) || {};
                const theme = themeForBuilding(rec);
                // strip existing theme-*, then add
                el.className = el.className.replace(/\btheme-(mohammedi|mufaddal|snood|baha)\b/g, '').trim();
                el.classList.add(theme);
            }
        }

        // Extra-safe: if the browser fires beforeprint late, re-apply themes
        function beforePrint() { if (GL_MODE_ACTIVE) { applyThemesForGL(); } }
        function afterPrint() { clearThemes(); GL_MODE_ACTIVE = false; }
        if ('onbeforeprint' in window) window.addEventListener('beforeprint', beforePrint);
        if ('onafterprint' in window) window.addEventListener('afterprint', afterPrint);
        if (window.matchMedia) {
            const mql = window.matchMedia('print');
            try { mql.addEventListener('change', e => { if (e.matches) beforePrint(); else afterPrint(); }); }
            catch { mql.addListener(e => { if (e.matches) beforePrint(); else afterPrint(); }); }
        }

        // Force a couple of animation frames and font readiness so page 1 is correct
        function nextFrames(n = 2) { return new Promise(res => { const tick = () => { if (n-- <= 0) res(); else requestAnimationFrame(tick) }; requestAnimationFrame(tick); }); }
        async function stablePrint() {
            try { if (document.fonts && document.fonts.ready) await document.fonts.ready; } catch { }
            // flush layout twice
            await nextFrames(2); void document.documentElement.offsetHeight; await nextFrames(1);
            window.print();
        }

        /* Wire events */
        $('btnLoad').addEventListener('click', () => { const id = Number($('savedList').value); const rec = CACHE.find(x => x.id === id); if (!rec) { alert('Select a valid slip.'); return; } CURRENT = [rec]; renderSlips(); $('status').textContent = `Loaded #${rec.id}${rec.sh_no ? ' (SH ' + rec.sh_no + ')' : ''}`; });

        $('btnFetch').addEventListener('click', async () => { const raw = $('shFetch').value || ''; const tokens = parseShList(raw); if (!tokens.length) { alert('Enter one or more SH numbers.'); return; } if (!CACHE.length) CACHE = await getAllRecords(); const found = []; const missed = []; for (const t of tokens) { const rec = CACHE.find(r => String(r.sh_no || '').trim() === String(t).trim()); if (rec) found.push(rec); else missed.push(t); } CURRENT = found; renderSlips(); const msg = `Fetched ${found.length}/${tokens.length} slip(s)` + (missed.length ? `. Missing: ${missed.join(', ')}` : ''); $('status').textContent = msg; });

        $('shFetch').addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey || !e.shiftKey)) { e.preventDefault(); $('btnFetch').click(); } });

        $('rows').addEventListener('change', renderSlips);

        // Plain Print: ensure no GL theming bleeds into it
        $('btnPrint').addEventListener('click', () => { clearThemes(); GL_MODE_ACTIVE = false; window.print(); });

        // GL Copy: apply building-based colors just for this print, then restore
        $('btnGLCopy').addEventListener('click', async () => {
            clearThemes();
            GL_MODE_ACTIVE = true; // used by beforeprint hook
            applyThemesForGL();
            // give the DOM time to paint the first page with themes
            await stablePrint();
            // fallback cleanup in case afterprint never fires
            setTimeout(() => { if (GL_MODE_ACTIVE) { afterPrint(); } }, 2000);
        });

        (async function init() { await refreshList(); renderSlips(); })();
    </script>
</body>
</html>
