<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="./logo.png">
    <title>Grid</title>
    <style>
        :root {
            /* Cream • Gold • Brown palette */
            --ink: #2b1e15; /* body text (deep brown) */
            --muted: #6b5e4a; /* secondary text */
            --card: #fffaf1; /* panels/cards (warm off-white) */
            --border: #dcc7a4; /* soft border */
            --hdrBg: #f3e6ca; /* table/headers (light cream) */

            --gold: #d4af37; /* accent */
            --gold2: #f3d984; /* softer accent */

            --ok: #2f7d32; /* success */
            --warn: #a86a00; /* warning */
            --bad: #a12a2a; /* error */

            --vacant: #fffdf5; /* cell vacant */
            --occupied: #e8c765; /* cell occupied (muted gold) */

            --cellW: 60px;
            --cellH: 45px;
            --fs: 24px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ink: #f3eadf;
                --muted: #b9a992;
                --card: #1f1711;
                --border: #3d2d20;
                --hdrBg: #2a1e14;
                --gold: #e0c457;
                --gold2: #f0d989;
                --ok: #48b65b;
                --warn: #d1901a;
                --bad: #d05a5a;
                --vacant: #16100b;
                --occupied: #6f5419;
            }
        }

        * {
            box-sizing: border-box
        }

        body {
            font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background: #f7efe1 url("./pattern_gold_2x.png") repeat;
            background-size: 150px auto;
            margin: 15px;
            color: var(--ink);
        }

        /* Full viewport layout */
        .wrap {
            height: calc(100vh - 58px);
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }

            .toolbar .group {
                display: flex;
                gap: 8px;
                align-items: end;
                flex-wrap: wrap
            }

        label.small {
            font-size: 12px;
            color: var(--muted);
            display: block
        }

        input, select, button {
            font: inherit;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px 10px;
            background: #fffdf5;
            color: var(--ink);
        }

        button {
            cursor: pointer;
            transition: background .15s ease, transform .08s ease, filter .15s ease
        }

            button:hover {
                background: #fff6dd
            }

            button:active {
                transform: translateY(1px)
            }

            button.primary {
                border-color: var(--gold2);
                background: linear-gradient(0deg, color-mix(in oklab, var(--gold) 16%, transparent) 0%, color-mix(in oklab, var(--gold) 16%, transparent) 100%), #fffaf1;
            }

        .spacer {
            flex: 1 1 auto
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }

        .tab {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            background: #fffdf5;
            color: var(--ink);
            transition: background .15s ease, color .15s ease, border-color .15s ease;
        }

            .tab:hover {
                background: #fff6dd
            }

            .tab[aria-selected="true"] {
                background: var(--gold);
                border-color: var(--gold);
                color: #2b1e15;
                font-weight: 700;
                text-shadow: 0 0 .01px currentColor;
            }

        /* Matrix */
        .stage {
            flex: 1 1 auto;
            min-height: 0;
            background: var(--card)
        }

        .matrix-wrap {
            height: 100%;
            width: 100%;
            overflow: auto
        }

        .matrix {
            display: grid;
            border-top: 1px solid var(--border);
            border-left: 1px solid var(--border);
            background: #fff;
        }

        .hcell, .rcell, .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .hcell {
            position: sticky;
            top: 0;
            z-index: 2;
            background: var(--hdrBg);
            text-align: center;
            font-weight: 800;
            padding: 6px;
            font-size: calc(var(--fs) + 1px);
            color: var(--ink);
        }

        .rcell {
            position: sticky;
            left: 0;
            z-index: 1;
            background: var(--hdrBg);
            font-weight: 800;
            padding: 6px;
            text-align: center;
            font-size: calc(var(--fs) + 1px);
            color: var(--ink);
        }

        .corner {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 3;
            background: var(--hdrBg)
        }

        .cell {
            width: var(--cellW);
            height: var(--cellH);
            display: grid;
            grid-template-rows: auto auto 1fr;
            align-items: center;
            justify-items: center;
            padding: 6px;
            font-size: var(--fs);
            background: var(--vacant);
            color: var(--ink);
        }

            .cell .cap {
                font-weight: 700;
                color: var(--ok)
            }

            .cell .meta {
                font-size: calc(var(--fs) - 1px);
                text-align: center;
                line-height: 1.1;
                color: var(--muted)
            }

            .cell.occ {
                background: var(--occupied);
                color: #2b1e15;
            }

                .cell.occ .cap {
                    color: currentColor
                }

            /* Under-assigned override: gold warning */
            .cell.under {
                background: var(--warn) !important;
                color: #663300 !important;
            }

                .cell.under .cap {
                    color: #663300 !important
                }

        .legend {
            padding: 6px 12px;
            font-size: 12px;
            color: var(--muted);
            background: var(--card);
            border-top: 1px solid var(--border);
        }

        /* size bar */
        .sizebar {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .sizegrp {
            display: flex;
            gap: 6px;
            align-items: center
        }

            .sizegrp input[type="range"] {
                width: 160px
            }

        .iconbtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff0;
            cursor: pointer;
            transition: background .15s ease, transform .08s ease;
        }

            .iconbtn:hover {
                background: #fff3cf
            }

            .iconbtn:active {
                transform: translateY(1px)
            }

        /* Global darkest-brown typography override */
        :root {
            --ink: #663300; /* darkest brown for ALL text */
            --muted: #663300; /* no timid grays */
            /* keep the rest as-is, but nudge warn bg for contrast */
            --warn: #a86a00;
            --warnBG: #ffe7b3; /* pale gold so dark text is readable */
        }

        /* Kill any local color overrides trying to be clever */
        body,
        .toolbar, .tabs, .tab,
        .hcell, .rcell, .cell, .cell .meta,
        .legend, table, th, td, label,
        input, select, button, textarea {
            color: var(--ink) !important;
        }

            /* Selected tab uses brown text too */
            .tab[aria-selected="true"] {
                color: var(--ink) !important;
            }

            /* Occupied/under cells keep dark text */
            .cell.occ {
                color: var(--ink) !important;
            }

            .cell.under {
                background: var(--warnBG) !important;
                color: var(--ink) !important;
            }

            .cell .cap {
                color: var(--ink) !important;
            }

        /* Dark mode: keep cream/brown vibe instead of flipping to gray-on-black */
        @media (prefers-color-scheme: dark) {
            :root {
                --ink: #663300;
                --muted: #663300;
                --card: #fffaf1;
                --border: #dcc7a4;
                --hdrBg: #f3e6ca;
                --vacant: #663300;
                --occupied: #663300;
            }
        }
        /* ===== Exact-color, exact-layout printing for the grid ===== */
        @media print {
            /* Scope printing to the element you tag as .print-scope */
            body {
                margin: 0
            }

                body * {
                    visibility: hidden !important
                }

            .print-scope,
            .print-scope * {
                visibility: visible !important;
            }

            /* Keep the element in normal flow so the grid dimensions don’t mutate */
            .print-scope {
                position: static !important;
                inset: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }

                /* If your grid sits inside a scroll container, open it up */
                .print-scope .matrix-wrap {
                    height: auto !important;
                    overflow: visible !important;
                }

                /* Sticky headers don’t “stick” on paper; render them as static */
                .print-scope .hcell,
                .print-scope .rcell,
                .print-scope .corner {
                    position: static !important;
                    top: auto !important;
                    left: auto !important;
                    z-index: auto !important;
                }

            /* Color fidelity across browsers */
            *, *::before, *::after {
                -webkit-print-color-adjust: exact !important; /* Chrome/Edge/Safari */
                print-color-adjust: exact !important; /* Modern spec */
                color-adjust: exact !important; /* Legacy */
            }

            /* Borders and backgrounds should match on-screen */
            .print-scope .matrix,
            .print-scope .hcell,
            .print-scope .rcell,
            .print-scope .cell {
                background: inherit; /* keep your current bg */
                border-color: inherit; /* keep your current border color */
                box-shadow: none !important; /* shadows waste toner and can band */
            }

            /* Avoid page breaks slicing through rows/columns */
            .print-scope,
            .print-scope .matrix,
            .print-scope .row,
            .print-scope .cell {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }

            /* Optional: edge-to-edge */
            @page {
                size: auto;
                margin: 8mm
            }
            /* tweak if you want tighter margins */
        }


    </style>

</head>
<body>
    <!-- Navbar --> <site-nav></site-nav>
    <script type="module" src="./site-nav.js"></script>


    <div class="wrap">
        <div class="toolbar">
            <div class="group">
                <div>
                    <label class="small" for="asof_date">Date</label>
                    <input id="asof_date" type="date">
                </div>
                <div>
                    <label class="small" for="asof_time">Time</label>
                    <input id="asof_time" type="time" step="60">
                </div>
                <button id="btnRecalc" class="primary">Recalculate</button>
                <button id="btnRefresh">Refresh DB</button>
                <button id="btnPrintGrid">Print grid</button>
            </div>
            <div class="spacer"></div>
            <div class="sizebar">
                <div class="sizegrp" title="Cell width">
                    <span class="small">Width</span>
                    <button class="iconbtn" id="wMinus">–</button>
                    <input id="wRange" type="range" min="1" max="240" step="2" value="65">
                    <button class="iconbtn" id="wPlus">+</button>
                </div>
                <div class="sizegrp" title="Cell height">
                    <span class="small">Height</span>
                    <button class="iconbtn" id="hMinus">–</button>
                    <input id="hRange" type="range" min="1" max="200" step="2" value="35">
                    <button class="iconbtn" id="hPlus">+</button>
                </div>
                <div class="sizegrp" title="Text size">
                    <span class="small">Text</span>
                    <button class="iconbtn" id="fMinus">–</button>
                    <input id="fRange" type="range" min="1" max="20" step="1" value="10">
                    <button class="iconbtn" id="fPlus">+</button>
                </div>
            </div>
        </div>

        <div class="tabs" id="tabs"></div>

        <div class="stage">
            <div class="matrix-wrap">
                <div class="matrix" id="matrix"></div>
            </div>
            <div class="legend" id="status">Loading DB…</div>
        </div>
    </div>

    <script>
/* ===================== IndexedDB v2 ===================== */
const DB_NAME='pms_accommodation_db', STORE='slips', DB_VERSION=2;
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      const has = db.objectStoreNames.contains(STORE);
      const st = has ? e.target.transaction.objectStore(STORE)
                     : db.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
      if (!st.indexNames.contains('createdAt')) st.createIndex('createdAt','createdAt',{unique:false});
      if (!st.indexNames.contains('sh_no'))     st.createIndex('sh_no','sh_no',{unique:false});
      if (!st.indexNames.contains('building'))  st.createIndex('building','building',{unique:false});
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror =()=>reject(req.error);
  });
}
async function getAllRecords(){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE,'readonly'); const st = tx.objectStore(STORE);
    const rq = st.getAll();
    rq.onsuccess=()=>resolve(rq.result||[]);
    rq.onerror =()=>reject(rq.error);
    tx.oncomplete=()=>db.close();
  });
}

/* ===================== Helpers ===================== */
function $(id){ return document.getElementById(id); }
function pad(n){ return String(n).padStart(2,'0'); }
function parseDT(d,t){ if(!d) return null; const tt=t&&t.length?t:'00:00'; const v=new Date(`${d}T${tt}`); return isNaN(v)?null:v; }
function fmtDT(dt){ try{ return dt.toLocaleString([], {month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}) }catch(e){ return dt.toISOString().slice(5,16).replace('T',' ') } }
function uniq(a){ return Array.from(new Set(a)); }
function cleanRoom(x){ return String(x??'').trim(); }

/* Parse room token to floor + column */
function parseRoomToken(room){
  const r = cleanRoom(room);
  const m = r.match(/^(\d+)([A-Za-z]*)$/);
  if(!m) return {floor:'?', col:r};
  const digits=m[1], suf=m[2]||'';
  if(digits.length<=2) return {floor:'0', col:digits+suf};
  return {floor:digits.slice(0,-2), col:digits.slice(-2)+suf};
}

/* Room lists */
function roomsFromSlip(rec){
  const bag=[];
  (rec.rooms?.gents||[]).forEach(x=>bag.push(cleanRoom(x.room_no)));
  (rec.rooms?.ladies||[]).forEach(x=>bag.push(cleanRoom(x.room_no)));
  return bag.filter(Boolean);
}

function buildInventoryPerBuilding(records, building){
  const rooms=[];
  records.forEach(r=>{
    if((r.building||'').trim()!==building) return;
    rooms.push(...roomsFromSlip(r));
  });
  const uniqRooms=uniq(rooms);
  const floors=new Map(), cellToRoom=new Map();
  uniqRooms.forEach(room=>{
    const {floor,col}=parseRoomToken(room);
    if(!floors.has(floor)) floors.set(floor,new Set());
    floors.get(floor).add(col);
    cellToRoom.set(`${floor}|${col}`, room);
  });
  const flist=Array.from(floors.keys()).sort((a,b)=>Number(a)-Number(b));
  const allCols=new Set(); flist.forEach(f=>floors.get(f).forEach(c=>allCols.add(c)));
  const clist=Array.from(allCols).sort((a,b)=>{
    const an=parseInt(a,10), bn=parseInt(b,10);
    if(!isNaN(an)&&!isNaN(bn)&&an!==bn) return an-bn;
    return a.localeCompare(b,undefined,{sensitivity:'base',numeric:true});
  });
  return {flist, clist, cellToRoom};
}

/* Occupancy helpers */
let CACHE=[];
function overlapsIn(when,ci,co){ return when>=ci && when<co; }

function activeStay(when,building,room){
  const out=[];
  for(const r of CACHE){
    if((r.building||'').trim()!==building) continue;
    const ci=parseDT(r.checkin_date,r.checkin_time);
    const co=parseDT(r.checkout_date,r.checkout_time);
    if(!ci||!co) continue;
    if(!overlapsIn(when,ci,co)) continue;
    const rms=roomsFromSlip(r);
    if(rms.includes(room)) out.push(r);
  }
  if(!out.length) return null;
  out.sort((a,b)=>parseDT(a.checkout_date,a.checkout_time)-parseDT(b.checkout_date,b.checkout_time));
  return out[0];
}
function nextStay(when,building,room){
  const out=[];
  for(const r of CACHE){
    if((r.building||'').trim()!==building) continue;
    const ci=parseDT(r.checkin_date,r.checkin_time);
    if(!ci || !(ci>when)) continue;
    const rms=roomsFromSlip(r);
    if(rms.includes(room)) out.push(r);
  }
  if(!out.length) return null;
  out.sort((a,b)=>parseDT(a.checkin_date,a.checkin_time)-parseDT(b.checkin_date,b.checkin_time));
  return out[0];
}

/* Latest known capacity map (fallback if slip has none) */
function buildCapacityMap(building){
  const cap=new Map();
  const sorted=[...CACHE].sort((a,b)=>(a.createdAt>b.createdAt?-1:1));
  for(const r of sorted){
    if((r.building||'').trim()!==building) continue;
    (r.rooms?.gents||[]).forEach(x=>{
      const key=`${building}|${cleanRoom(x.room_no)}`;
      const c=(x.capacity===''||x.capacity==null)?null:Number(x.capacity);
      if(!cap.has(key) && c!=null) cap.set(key,c);
    });
    (r.rooms?.ladies||[]).forEach(x=>{
      const key=`${building}|${cleanRoom(x.room_no)}`;
      const c=(x.capacity===''||x.capacity==null)?null:Number(x.capacity);
      if(!cap.has(key) && c!=null) cap.set(key,c);
    });
  }
  return cap;
}

/* Find the per-room entry inside a slip to read assigned/capacity */
function roomEntryFromSlip(rec, room){
  const rn = cleanRoom(room);
  let hit = (rec.rooms?.gents||[]).find(x=>cleanRoom(x.room_no)===rn);
  if(!hit) hit = (rec.rooms?.ladies||[]).find(x=>cleanRoom(x.room_no)===rn);
  return hit || null;
}

/* ===================== UI: tabs and matrix ===================== */
const CANON_BUILDINGS=[];

function renderTabs(buildings){
  const tabs=$('tabs'); tabs.innerHTML='';
  buildings.forEach((b,i)=>{
    const btn=document.createElement('button');
    btn.className='tab'; btn.textContent=b;
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', String(i===0));
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      renderMatrix(b);
    });
    tabs.appendChild(btn);
  });
}

function renderMatrix(building){
  const dateStr=$('asof_date').value, timeStr=$('asof_time').value;
  if(!dateStr||!timeStr){ alert('Choose date and time'); return; }
  const when=new Date(`${dateStr}T${timeStr}`); if(isNaN(when)){ alert('Invalid date/time'); return; }

  const mx=$('matrix'); mx.innerHTML='';
  const {flist, clist, cellToRoom}=buildInventoryPerBuilding(CACHE, building);
  if(!flist.length){ mx.textContent='No rooms found for this building.'; return; }

  mx.style.gridTemplateColumns = `repeat(${clist.length + 1}, max-content)`;

  const corner=document.createElement('div');
  corner.className='hcell corner'; corner.style.width='84px'; corner.style.height='44px'; corner.textContent=building;
  mx.appendChild(corner);

  clist.forEach(col=>{
    const h=document.createElement('div');
    h.className='hcell'; h.style.width='var(--cellW)'; h.style.height='44px'; h.textContent=col;
    mx.appendChild(h);
  });

  const capMap=buildCapacityMap(building);

  flist.forEach(floor=>{
    const rhead=document.createElement('div');
    rhead.className='rcell'; rhead.style.width='84px'; rhead.style.height='var(--cellH)'; rhead.textContent=`FLOOR ${floor}`;
    mx.appendChild(rhead);

    clist.forEach(col=>{
      const key=`${floor}|${col}`;
      const room=cellToRoom.get(key)||null;

      const cell=document.createElement('div');
      cell.className='cell';
      cell.style.width='var(--cellW)'; cell.style.height='var(--cellH)';

      if(!room){
        cell.innerHTML = `<div class="cap">—</div><div class="meta">&nbsp;</div>`;
      } else {
        const occ  = activeStay(when, building, room);
        const next = occ ? null : nextStay(when, building, room);

        // Resolve capacity and assigned, preferring the ACTIVE SLIP's room entry
        const entry = occ ? roomEntryFromSlip(occ, room) : null;
        let cap = null, assigned = null;

        if (entry){
          cap      = (entry.capacity===''||entry.capacity==null) ? null : Number(entry.capacity);
          assigned = (entry.assigned===''||entry.assigned==null) ? null : Number(entry.assigned);
        }
        if (cap==null) {
          const fallback = capMap.get(`${building}|${room}`);
          cap = Number.isFinite(fallback) ? fallback : null;
        }

        const capTxt = Number.isFinite(cap) ? String(cap) : '—';

        if (occ){
          const co = parseDT(occ.checkout_date, occ.checkout_time);
          const sh = occ.sh_no ?? '';

          // Under-assigned only when both numbers exist and assigned < capacity
          const under = (assigned!=null && cap!=null && assigned < cap);
          const vacBeds = under ? (cap - assigned) : null;

          cell.classList.add('occ');
          if (under) cell.classList.add('under');

          cell.innerHTML = `
            <div class="cap">${capTxt}${under ? ' · Vac ' + vacBeds : ''}</div>
            <div class="meta">SH ${sh || '—'} • Out ${co ? fmtDT(co) : '—'}</div>
          `;
        } else {
          const ci = next ? parseDT(next.checkin_date, next.checkin_time) : null;
          const nsh = next ? (next.sh_no ?? '') : '';
          cell.innerHTML = `
            <div class="cap">${capTxt}</div>
            <div class="meta">${next ? ('Next ' + fmtDT(ci) + (nsh ? ' • SH ' + nsh : '')) : 'Vacant'}</div>
          `;
        }
      }
      mx.appendChild(cell);
    });
  });

  $('status').textContent = `${building} • Floors ${flist.join(', ')} • ${clist.length} columns • ${CACHE.length} slip(s)`;
}

/* ===================== Size controls ===================== */
function setVar(name,val){ document.documentElement.style.setProperty(name,val); }
function clamp(n,lo,hi){ return Math.max(lo, Math.min(hi, n)); }
function wireSizeControls(){
  const wR=$('wRange'), hR=$('hRange'), fR=$('fRange');
  const wM=$('wMinus'), wP=$('wPlus'), hM=$('hMinus'), hP=$('hPlus'), fM=$('fMinus'), fP=$('fPlus');
  const apply=()=>{ setVar('--cellW', wR.value+'px'); setVar('--cellH', hR.value+'px'); setVar('--fs', fR.value+'px'); };
  [wR,hR,fR].forEach(el=>el.addEventListener('input', apply));
  const step=(el,d,min,max)=>{ el.value = clamp(Number(el.value)+d, min, max); el.dispatchEvent(new Event('input')); };
  if(wM) wM.onclick=()=>step(wR,-8,80,240);
  if(wP) wP.onclick=()=>step(wR, 8,80,240);
  if(hM) hM.onclick=()=>step(hR,-8,60,200);
  if(hP) hP.onclick=()=>step(hR, 8,60,200);
  if(fM) fM.onclick=()=>step(fR,-1,9,20);
  if(fP) fP.onclick=()=>step(fR, 1,9,20);
  apply();
}

/* ===================== Boot ===================== */
(async function boot(){
  try{
    CACHE = await getAllRecords();
  }catch(e){
    $('status').textContent='Could not open local DB (IndexedDB blocked?).';
    console.error(e); return;
  }
  const now=new Date();
  const y=now.getFullYear(), m=pad(now.getMonth()+1), d=pad(now.getDate());
  const h=pad(now.getHours()), n=pad(now.getMinutes());
  if(!$('asof_date').value) $('asof_date').value = `${y}-${m}-${d}`;
  if(!$('asof_time').value) $('asof_time').value = `${h}:${n}`;

  const fromData = uniq(CACHE.map(r=>(r.building||'').trim()).filter(Boolean));
  const buildings = uniq([...CANON_BUILDINGS, ...fromData]).filter(Boolean);
  renderTabs(buildings);
  if(buildings.length) renderMatrix(buildings[0]);

  $('btnRecalc').addEventListener('click', ()=>{
    const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
    renderMatrix(sel);
  });
  $('btnRefresh').addEventListener('click', async ()=>{
    CACHE = await getAllRecords();
    const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
    renderMatrix(sel);
  });
  $('asof_date').addEventListener('change', ()=>{
    const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
    renderMatrix(sel);
  });
  $('asof_time').addEventListener('change', ()=>{
    const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
    renderMatrix(sel);
  });

  wireSizeControls();
        })();
        function printOnlyById(id) {
            const el = document.getElementById(id);
            if (!el) return alert('Matrix not found.');
            el.classList.add('print-scope');
            const cleanup = () => {
                el.classList.remove('print-scope');
                window.removeEventListener('afterprint', cleanup);
            };
            window.addEventListener('afterprint', cleanup);
            setTimeout(() => window.print(), 0);
        }

        // Example wiring:
        document.getElementById('btnPrintGrid')
            ?.addEventListener('click', () => printOnlyById('matrix'));


    </script>
</body>
</html>
