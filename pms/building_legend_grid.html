<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PMS ‚Äî Building Matrix (Floors √ó Room Numbers)</title>
    <style>
        :root {
            --ink: #0b1220;
            --muted: #64748b;
            --card: #ffffff;
            --border: #e5e7eb;
            --ok: #16a34a;
            --warn: #f59e0b;
            --bad: #ef4444;
            --vacant: #ffffff;
            --occupied: #ef4444;
            --cellW: 120px;
            --cellH: 92px;
            --fs: 12px;
            --hdrBg: #f8fafc;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ink: #e5e7eb;
                --muted: #9aa4b2;
                --card: #0f1216;
                --border: #1f2937;
                --hdrBg: #0f172a;
                --vacant: #0b1220;
                --occupied: #dc2626;
            }
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--ink);
            background: #f6f7fb
        }
        /* Navbar */
        .min-nav {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            background: rgba(255,255,255,.85);
            backdrop-filter: blur(6px)
        }

            .min-nav a {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                color: #0b1220;
                text-decoration: none;
                padding: 6px 10px;
                border-radius: 10px
            }

                .min-nav a:hover {
                    text-decoration: underline
                }

                .min-nav a[aria-current="page"] {
                    font-weight: 700;
                    background: #f3f4f6
                }

            .min-nav .e {
                font-size: 1.05em
            }

        @media (prefers-color-scheme: dark) {
            .min-nav {
                background: rgba(15,18,22,.7);
                border-color: #1f2937
            }

                .min-nav a {
                    color: #e5e7eb
                }

                    .min-nav a[aria-current="page"] {
                        background: #0f172a
                    }
        }

        /* Full viewport layout */
        .wrap {
            height: calc(100vh - 58px);
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }

            .toolbar .group {
                display: flex;
                gap: 8px;
                align-items: end;
                flex-wrap: wrap
            }

        label.small {
            font-size: 12px;
            color: var(--muted);
            display: block
        }

        input, select, button {
            font: inherit;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px 10px;
            background: #fff;
            color: var(--ink)
        }

            button.primary {
                border-color: #99f6e4;
                background: linear-gradient(0deg,rgba(34,211,238,.12),rgba(34,211,238,.12))
            }

        .spacer {
            flex: 1 1 auto
        }

        /* Building tabs */
        .tabs {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: #fff
        }

        .tab {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            background: #fff;
            color: var(--ink)
        }

            .tab[aria-selected="true"] {
                background: #0ea5e9;
                border-color: #0ea5e9;
                color: #fff;
                font-weight: 700
            }

        /* Matrix area fills rest of screen */
        .stage {
            flex: 1 1 auto;
            min-height: 0; /* allow internal scroll if necessary */
            background: #fff
        }

        .matrix-wrap {
            height: 100%;
            width: 100%;
            overflow: auto
        }

        .matrix {
            display: grid;
            border-top: 1px solid var(--border);
            border-left: 1px solid var(--border);
            background: #fff
        }

        .hcell, .rcell, .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .hcell {
            position: sticky;
            top: 0;
            z-index: 2;
            background: var(--hdrBg);
            text-align: center;
            font-weight: 800;
            padding: 6px;
            font-size: calc(var(--fs) + 1px);
        }

        .rcell {
            position: sticky;
            left: 0;
            z-index: 1;
            background: var(--hdrBg);
            font-weight: 800;
            padding: 6px;
            text-align: center;
            font-size: calc(var(--fs) + 1px);
        }

        .corner {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 3;
            background: var(--hdrBg)
        }

        .cell {
            width: var(--cellW);
            height: var(--cellH);
            display: grid;
            grid-template-rows: auto auto 1fr;
            align-items: center;
            justify-items: center;
            padding: 6px;
            font-size: var(--fs);
            background: var(--vacant);
        }

            .cell .rn {
                font-weight: 800;
                font-size: calc(var(--fs) + 2px);
                line-height: 1
            }

            .cell .cap {
                font-weight: 700;
                color: var(--ok)
            }

            .cell .meta {
                font-size: calc(var(--fs) - 1px);
                text-align: center;
                line-height: 1.1
            }

            .cell.occ {
                background: var(--occupied);
                color: #fff
            }

                .cell.occ .cap {
                    color: #fff
                }

        .legend {
            padding: 6px 12px;
            font-size: 12px;
            color: var(--muted);
            background: #fff;
            border-top: 1px solid var(--border)
        }

        /* size bar */
        .sizebar {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .sizegrp {
            display: flex;
            gap: 6px;
            align-items: center
        }

            .sizegrp input[type="range"] {
                width: 160px
            }

        .iconbtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff0;
            cursor: pointer
        }

            .iconbtn:hover {
                background: #f1f5f9
            }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="min-nav" role="navigation" aria-label="Primary">
        <a href="index.html"><span class="e">üè†</span><span>Home</span></a>
        <a href="accommodation_slip.html"><span class="e">üìù</span><span>Slip</span></a>
        <a href="vacancy_forecast.html"><span class="e">üìà</span><span>Forecast</span></a>
        <a href="building_legend_grid.html" aria-current="page"><span class="e">üß©</span><span>Legend Grid</span></a>
        <a href="checkins_checkouts.html"><span class="e">üóìÔ∏è</span><span>Checkins/Checkouts</span></a>
        <a href="print_slip_a5.html"><span class="e">üñ®Ô∏è</span><span>Print</span></a>
        <a href="slip_admin.html"><span class="e">üóÑÔ∏è</span><span>Admin</span></a>
        <a href="pms_instructions.html"><span class="e">üìñ</span><span>Instructions</span></a>
    </nav>

    <div class="wrap">
        <!-- Top toolbar -->
        <div class="toolbar">
            <div class="group">
                <div>
                    <label class="small" for="asof_date">Date</label>
                    <input id="asof_date" type="date">
                </div>
                <div>
                    <label class="small" for="asof_time">Time</label>
                    <input id="asof_time" type="time" step="60">
                </div>
                <button id="btnRecalc" class="primary">Recalculate</button>
                <button id="btnRefresh">Refresh DB</button>
            </div>
            <div class="spacer"></div>
            <div class="sizebar">
                <div class="sizegrp" title="Cell width">
                    <span class="small">Width</span>
                    <button class="iconbtn" id="wMinus">‚Äì</button>
                    <input id="wRange" type="range" min="80" max="240" step="2" value="120">
                    <button class="iconbtn" id="wPlus">+</button>
                </div>
                <div class="sizegrp" title="Cell height">
                    <span class="small">Height</span>
                    <button class="iconbtn" id="hMinus">‚Äì</button>
                    <input id="hRange" type="range" min="60" max="200" step="2" value="92">
                    <button class="iconbtn" id="hPlus">+</button>
                </div>
                <div class="sizegrp" title="Text size">
                    <span class="small">Text</span>
                    <button class="iconbtn" id="fMinus">‚Äì</button>
                    <input id="fRange" type="range" min="9" max="20" step="1" value="12">
                    <button class="iconbtn" id="fPlus">+</button>
                </div>
            </div>
        </div>

        <!-- Building tabs -->
        <div class="tabs" id="tabs"></div>

        <!-- Matrix area -->
        <div class="stage">
            <div class="matrix-wrap">
                <div class="matrix" id="matrix"></div>
            </div>
            <div class="legend" id="status">Loading DB‚Ä¶</div>
        </div>
    </div>

    <script>
        /* ===================== IndexedDB v2 ===================== */
        const DB_NAME = 'pms_accommodation_db', STORE = 'slips', DB_VERSION = 2;
        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    const has = db.objectStoreNames.contains(STORE);
                    const st = has ? e.target.transaction.objectStore(STORE)
                        : db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
                    if (!st.indexNames.contains('createdAt')) st.createIndex('createdAt', 'createdAt', { unique: false });
                    if (!st.indexNames.contains('sh_no')) st.createIndex('sh_no', 'sh_no', { unique: false });
                    if (!st.indexNames.contains('building')) st.createIndex('building', 'building', { unique: false });
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function getAllRecords() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readonly'); const st = tx.objectStore(STORE);
                const rq = st.getAll();
                rq.onsuccess = () => resolve(rq.result || []); rq.onerror = () => reject(rq.error);
                tx.oncomplete = () => db.close();
            });
        }

        /* ===================== Helpers ===================== */
        function $(id) { return document.getElementById(id); }
        function pad(n) { return String(n).padStart(2, '0'); }
        function parseDT(d, t) { if (!d) return null; const tt = t && t.length ? t : '00:00'; const v = new Date(`${d}T${tt}`); return isNaN(v) ? null : v; }
        function fmtDT(dt) { try { return dt.toLocaleString([], { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) } catch (e) { return dt.toISOString().slice(5, 16).replace('T', ' ') } }
        function uniq(a) { return Array.from(new Set(a)); }
        function cleanRoom(x) { return String(x ?? '').trim(); }

        /* Parse floor and column token from a room like 501, 1203, 502A, 1002B
           Rule: take leading digits; floor = all but the last 2 digits (min 1).
                 col = last 2 digits + any trailing letters.
           e.g. 501 -> floor '5', col '01'
                1203 -> floor '12', col '03'
                502A -> floor '5', col '02A'
        */
        function parseRoomToken(room) {
            const r = cleanRoom(room);
            const m = r.match(/^(\d+)([A-Za-z]*)$/);
            if (!m) return { floor: '?', col: r };
            const digits = m[1]; const suf = m[2] || '';
            if (digits.length <= 2) return { floor: '0', col: digits + suf };
            const floor = digits.slice(0, -2);
            const col = digits.slice(-2) + suf;
            return { floor, col };
        }

        /* Compute inventory and column set for a building */
        function roomsFromSlip(rec) {
            const bag = [];
            (rec.rooms?.gents || []).forEach(x => bag.push(cleanRoom(x.room_no)));
            (rec.rooms?.ladies || []).forEach(x => bag.push(cleanRoom(x.room_no)));
            return bag.filter(Boolean);
        }

        function buildInventoryPerBuilding(records, building) {
            const rooms = [];
            records.forEach(r => {
                if ((r.building || '').trim() !== building) return;
                rooms.push(...roomsFromSlip(r));
            });
            const uniqRooms = uniq(rooms);
            // Map floor -> set(cols), and map floor+col -> canonical room string
            const floors = new Map();
            const cellToRoom = new Map();
            uniqRooms.forEach(room => {
                const { floor, col } = parseRoomToken(room);
                if (!floors.has(floor)) floors.set(floor, new Set());
                floors.get(floor).add(col);
                cellToRoom.set(`${floor}|${col}`, room);
            });
            // Build sorted floor list (numeric), and column list (numeric within two digits then letters)
            const flist = Array.from(floors.keys()).sort((a, b) => Number(a) - Number(b));
            const allCols = new Set(); flist.forEach(f => floors.get(f).forEach(c => allCols.add(c)));
            const clist = Array.from(allCols).sort((a, b) => {
                const an = parseInt(a, 10); const bn = parseInt(b, 10);
                if (!isNaN(an) && !isNaN(bn) && an !== bn) return an - bn;
                return a.localeCompare(b, undefined, { sensitivity: 'base', numeric: true });
            });
            return { flist, clist, cellToRoom };
        }

        /* Occupancy and capacity */
        let CACHE = [];
        function overlapsIn(when, ci, co) { return when >= ci && when < co; }

        function activeStay(when, building, room) {
            const out = [];
            for (const r of CACHE) {
                if ((r.building || '').trim() !== building) continue;
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                if (!ci || !co) continue;
                if (!overlapsIn(when, ci, co)) continue;
                const rms = roomsFromSlip(r);
                if (rms.includes(room)) out.push(r);
            }
            if (!out.length) return null;
            // If multiple, pick the one with earliest checkout after when
            out.sort((a, b) => parseDT(a.checkout_date, a.checkout_time) - parseDT(b.checkout_date, b.checkout_time));
            return out[0];
        }

        function nextStay(when, building, room) {
            const out = [];
            for (const r of CACHE) {
                if ((r.building || '').trim() !== building) continue;
                const ci = parseDT(r.checkin_date, r.checkin_time);
                if (!ci || !(ci > when)) continue;
                const rms = roomsFromSlip(r);
                if (rms.includes(room)) out.push(r);
            }
            if (!out.length) return null;
            out.sort((a, b) => parseDT(a.checkin_date, a.checkin_time) - parseDT(b.checkin_date, b.checkin_time));
            return out[0];
        }

        /* Capacity map: latest known capacity per building|room from any slip */
        function buildCapacityMap(building) {
            const cap = new Map();
            const sorted = [...CACHE].sort((a, b) => (a.createdAt > b.createdAt ? -1 : 1));
            for (const r of sorted) {
                if ((r.building || '').trim() !== building) continue;
                (r.rooms?.gents || []).forEach(x => {
                    const key = `${building}|${cleanRoom(x.room_no)}`;
                    const c = (x.capacity === '' || x.capacity == null) ? null : Number(x.capacity);
                    if (!cap.has(key) && c != null) cap.set(key, c);
                });
                (r.rooms?.ladies || []).forEach(x => {
                    const key = `${building}|${cleanRoom(x.room_no)}`;
                    const c = (x.capacity === '' || x.capacity == null) ? null : Number(x.capacity);
                    if (!cap.has(key) && c != null) cap.set(key, c);
                });
            }
            return cap;
        }

        /* ===================== UI: tabs and matrix ===================== */
        const CANON_BUILDINGS = [];

        function renderTabs(buildings) {
            const tabs = $('tabs'); tabs.innerHTML = '';
            buildings.forEach((b, i) => {
                const btn = document.createElement('button');
                btn.className = 'tab'; btn.textContent = b;
                btn.setAttribute('role', 'tab');
                btn.setAttribute('aria-selected', String(i === 0));
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.setAttribute('aria-selected', 'false'));
                    btn.setAttribute('aria-selected', 'true');
                    renderMatrix(b);
                });
                tabs.appendChild(btn);
            });
        }

        function renderMatrix(building) {
            const dateStr = $('asof_date').value, timeStr = $('asof_time').value;
            if (!dateStr || !timeStr) { alert('Choose date and time'); return; }
            const when = new Date(`${dateStr}T${timeStr}`);
            if (isNaN(when)) { alert('Invalid date/time'); return; }

            const mx = $('matrix'); mx.innerHTML = '';

            const { flist, clist, cellToRoom } = buildInventoryPerBuilding(CACHE, building);
            if (!flist.length) { mx.textContent = 'No rooms found for this building.'; return; }

            // CSS grid columns: 1 for row header + columns for each room token
            mx.style.gridTemplateColumns = `repeat(${clist.length + 1}, max-content)`;

            // Corner
            const corner = document.createElement('div');
            corner.className = 'hcell corner';
            corner.style.width = '84px'; corner.style.height = '44px';
            corner.textContent = building;
            mx.appendChild(corner);

            // Column headers
            clist.forEach(col => {
                const h = document.createElement('div');
                h.className = 'hcell';
                h.style.width = 'var(--cellW)';
                h.style.height = '44px';
                h.textContent = col; // like 01, 02A, 03
                mx.appendChild(h);
            });

            // Rows
            const capMap = buildCapacityMap(building);
            flist.forEach(floor => {
                // Row header
                const rhead = document.createElement('div');
                rhead.className = 'rcell';
                rhead.style.width = '84px';
                rhead.style.height = 'var(--cellH)';
                rhead.textContent = `FLOOR ${floor}`;
                mx.appendChild(rhead);

                // Cells
                clist.forEach(col => {
                    const key = `${floor}|${col}`;
                    const room = cellToRoom.get(key) || null;

                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.width = 'var(--cellW)';
                    cell.style.height = 'var(--cellH)';

                    if (!room) {
                        // empty slot
                        cell.innerHTML = `<div class="cap">‚Äî</div><div class="meta">&nbsp;</div>`;
                    } else {
                        const occ = activeStay(when, building, room);
                        const next = occ ? null : nextStay(when, building, room);
                        const cap = capMap.get(`${building}|${room}`);
                        const capTxt = Number.isFinite(cap) ? String(cap) : '‚Äî';

                        if (occ) {
                            const co = parseDT(occ.checkout_date, occ.checkout_time);
                            const sh = occ.sh_no ?? '';
                            cell.classList.add('occ');
                            cell.innerHTML = `
                
                <div class="cap">${capTxt}</div>
                <div class="meta">SH ${sh || '‚Äî'} ‚Ä¢ Out ${co ? fmtDT(co) : '‚Äî'}</div>
              `;
                        } else {
                            const ci = next ? parseDT(next.checkin_date, next.checkin_time) : null;
                            const nsh = next ? (next.sh_no ?? '') : '';
                            cell.innerHTML = `
                
                <div class="cap">${capTxt}</div>
                <div class="meta">${next ? ('Next ' + fmtDT(ci) + (nsh ? ' ‚Ä¢ SH ' + nsh : '')) : 'Vacant'}</div>
              `;
                        }
                    }
                    mx.appendChild(cell);
                });
            });

            $('status').textContent = `${building} ‚Ä¢ Floors ${flist.join(', ')} ‚Ä¢ ${clist.length} columns ‚Ä¢ ${CACHE.length} slip(s)`;
        }

        /* ===================== Size controls ===================== */
        function setVar(name, val) { document.documentElement.style.setProperty(name, val); }
        function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }
        function wireSizeControls() {
            const wR = $('wRange'), hR = $('hRange'), fR = $('fRange');
            const wM = $('wMinus'), wP = $('wPlus'), hM = $('hMinus'), hP = $('hPlus'), fM = $('fMinus'), fP = $('fPlus');
            const apply = () => { setVar('--cellW', wR.value + 'px'); setVar('--cellH', hR.value + 'px'); setVar('--fs', fR.value + 'px'); };
            [wR, hR, fR].forEach(el => el.addEventListener('input', apply));
            const step = (el, d, min, max) => { el.value = clamp(Number(el.value) + d, min, max); el.dispatchEvent(new Event('input')); };
            if (wM) wM.onclick = () => step(wR, -8, 80, 240);
            if (wP) wP.onclick = () => step(wR, 8, 80, 240);
            if (hM) hM.onclick = () => step(hR, -8, 60, 200);
            if (hP) hP.onclick = () => step(hR, 8, 60, 200);
            if (fM) fM.onclick = () => step(fR, -1, 9, 20);
            if (fP) fP.onclick = () => step(fR, 1, 9, 20);
            apply();
        }

        /* ===================== Boot ===================== */
        (async function boot() {
            try {
                CACHE = await getAllRecords();
            } catch (e) {
                $('status').textContent = 'Could not open local DB (IndexedDB blocked?).';
                console.error(e);
                return;
            }
            // date/time defaults
            const now = new Date();
            const y = now.getFullYear(), m = pad(now.getMonth() + 1), d = pad(now.getDate());
            const h = pad(now.getHours()), n = pad(now.getMinutes());
            if (!$('asof_date').value) $('asof_date').value = `${y}-${m}-${d}`;
            if (!$('asof_time').value) $('asof_time').value = `${h}:${n}`;

            // buildings present (union of canon + data)
            const fromData = uniq(CACHE.map(r => (r.building || '').trim()).filter(Boolean));
            const buildings = uniq([...CANON_BUILDINGS, ...fromData]).filter(Boolean);
            renderTabs(buildings);
            if (buildings.length) renderMatrix(buildings[0]);

            $('btnRecalc').addEventListener('click', () => {
                const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
                renderMatrix(sel);
            });
            $('btnRefresh').addEventListener('click', async () => {
                CACHE = await getAllRecords();
                const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
                renderMatrix(sel);
            });
            $('asof_date').addEventListener('change', () => {
                const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
                renderMatrix(sel);
            });
            $('asof_time').addEventListener('change', () => {
                const sel = document.querySelector('.tab[aria-selected="true"]')?.textContent || buildings[0];
                renderMatrix(sel);
            });

            wireSizeControls();
        })();
    </script>
</body>
</html>
