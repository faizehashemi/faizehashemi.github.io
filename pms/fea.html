<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="./logo.png">
    <title>FEA</title>
    <style>
        :root {
            --bg: #f6f8fb; /* page background */
            --panel: #ffffff; /* cards/panels */
            --muted: #5b6b7a; /* secondary text */
            --accent: #0ea5e9; /* links/buttons */
            --ok: #16a34a; /* success */
            --warn: #d97706; /* warning */
            --bad: #dc2626; /* error */
            --text: #0b1220; /* body text */
            --chip: #eef2f7; /* chip bg */
            --chipb: #e3eaf2; /* chip border/alt */
        }

        * {
            box-sizing: border-box
        }

        body {
            font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background: var(--bg) url("./pattern_gold_2x.png") repeat;
            background-size: 150px auto;
            margin: 15px;
            color: var(--text);
        }

        header {
            padding: 18px 14px 6px;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: .25px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .card {
            background: var(--panel);
            border: 1px solid #d7e0ea;
            border-radius: 14px;
            padding: 14px;
        }

        .shadow {
            box-shadow: 0 8px 22px rgba(10, 20, 30, .10)
        }

        .people {
            display: grid;
            gap: 8px
        }

        .person {
            display: grid;
            grid-template-columns: 1fr 86px 86px 86px minmax(160px,1fr) 108px;
            align-items: center;
            gap: 8px;
            background: var(--chip);
            border: 1px solid #d0dbe6;
            border-radius: 12px;
            padding: 8px;
        }

        .name {
            font-weight: 600
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--chipb);
            border: 1px solid #c7d4e2;
            color: var(--muted);
            font-size: 12px;
        }

        .grid {
            display: grid;
            gap: 12px
        }

        .actions button,
        button.copy {
            cursor: pointer;
            border: 1px solid var(--accent);
            background: #ffffff;
            color: var(--accent);
            padding: 10px 14px;
            border-radius: 12px;
            transition: background .15s ease, color .15s ease, filter .15s ease;
        }

            .actions button:hover,
            button.copy:hover {
                background: color-mix(in oklab, var(--accent) 8%, white);
            }

        .switch {
            display: inline-flex;
            align-items: center;
            gap: 6px
        }

            .switch input {
                width: 18px;
                height: 18px
            }

        .select,
        input[type=text] {
            width: 100%;
            background: #fff;
            color: var(--text);
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            padding: 8px;
        }

            .select:focus,
            input[type=text]:focus,
            select:focus,
            input[type=number]:focus,
            input[type=date]:focus,
            input[type=time]:focus {
                outline: 2px solid color-mix(in oklab, var(--accent) 65%, white);
                outline-offset: 1px;
            }

        .panel-title {
            font-weight: 700;
            margin: 0 0 6px
        }

        .small {
            font-size: 12px;
            color: var(--muted)
        }

        .cols {
            display: grid;
            grid-template-columns: 1.25fr .75fr;
            gap: 12px
        }

        .log {
            max-height: 320px;
            overflow: auto;
            border: 1px solid #d7e0ea;
            border-radius: 12px;
            background: #fff;
        }

        table {
            border-collapse: collapse;
            width: 100%
        }

        th, td {
            border-bottom: 1px solid #e3ebf3;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            top: 0;
            background: var(--chipb);
            z-index: 1;
        }

        .sr {
            opacity: .6
        }

        .sticky-actions {
            top: 0;
            z-index: 5;
            background: linear-gradient(to bottom, rgba(255,255,255,.96), rgba(255,255,255,.92));
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #dbe6f0;
            box-shadow: 0 6px 18px rgba(10,20,30,.10);
        }

        .notice {
            color: color-mix(in oklab, var(--accent) 80%, black)
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
        }

        .hint {
            color: var(--muted);
            font-size: 12px
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(4, minmax(120px,1fr));
            gap: 10px;
        }

            .kpi .card {
                padding: 10px 12px
            }

            .kpi h3 {
                margin: 2px 0 4px;
                font-size: 22px
            }

        .divider {
            height: 1px;
            background: #e4ebf3;
            margin: 10px 0
        }

        .del {
            border: 1px solid var(--bad);
            background: #fff;
            color: var(--bad);
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
        }

            .del:hover {
                background: #ffecec;
            }

        canvas {
            width: 100%;
            height: 260px;
            background: #f9fbfd;
            border: 1px solid #d7e0ea;
            border-radius: 10px;
        }

        .balanced {
            border: 1px dashed #4aa164;
            background: #eff8f1;
        }
    </style>

</head>
<body>
    <!-- Navbar --> <site-nav></site-nav>
    <script type="module" src="/components/site-nav.js"></script>

    <header>
        <h1>Fakkul Ehraam & Atraaf â€” Assignment Console</h1>
        <div class="row" style="align-items:center">
            <input id="sessionTitle" class="select" style="width:210px" value="Aaje Raate Haram" />
            <input id="sessionDate" class="select" type="datetime-local" style="width:210px" />
            <button class="copy" id="btnCopy">Copy to clipboard</button>
            <button id="btnExportExcel">Export Excel (.xls)</button>

        </div>
    </header>

    <main class="row" style="padding:0 12px 18px">
        <section class="card shadow" style="flex:1; min-width:640px">
            <div class="sticky-actions">
                <div class="row" style="justify-content:space-between; align-items:center">
                    <div>
                        <strong>People</strong>
                        <span class="small">Tick FE1/FE2/Atraaf. Pick a location for grouping. FE1 balancing helper is on the right.</span>
                    </div>
                    <div class="row" style="align-items:center; gap:8px">
                        <div class="row" style="gap:6px">
                            <input id="newPersonName" placeholder="Add person e.g. M Taha Kamlapur" type="text" style="width:260px" />
                            <button id="btnAddPerson">Add</button>
                        </div>
                        <div class="actions">
                            <button id="btnSave">Save assignment</button>
                            <button id="btnClearChecks" title="Uncheck everything">Clear ticks</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="divider"></div>

            <div class="people" id="peopleList"></div>
            <div class="hint" style="margin-top:10px">
                Saving logs the current date/time automatically. Stats, charts and history update instantly. Clipboard hides FE1/FE2 by design.
            </div>
        </section>

        <aside class="grid" style="width:560px; min-width:440px">
            <div class="card shadow">
                <p class="panel-title">Session preview (clipboard output)</p>
                <div id="preview" class="mono small notice" style="white-space:pre; background:#0a121a; border:1px solid #1b2a38; border-radius:10px; padding:8px; min-height:120px"></div>
                <div class="chips" style="margin-top:8px">
                    <span class="tag">Groups by <strong>location</strong></span>
                    <span class="tag">No FE1/FE2 shown</span>
                    <span class="tag">Only checked names</span>
                </div>
            </div>

            <div class="card shadow">
                <p class="panel-title">FE1 balance helper</p>
                <div class="row" style="align-items:center">
                    <button id="btnRecommendFE1">Recommend lowest FE1</button>
                    <input id="recCount" type="number" min="1" step="1" value="3" class="select" style="width:90px" />
                    <span class="small">ticks FE1 for N most under-served people (ties by least recent FE1)</span>
                </div>
                <div class="chips" id="fe1Leaderboard" style="margin-top:8px"></div>
            </div>

            <div class="card shadow">
                <p class="panel-title">Dashboard</p>
                <div class="kpi">
                    <div class="card"><div class="small">FE1 today</div><h3 id="kpiFE1Today">0</h3></div>
                    <div class="card"><div class="small">FE2 today</div><h3 id="kpiFE2Today">0</h3></div>
                    <div class="card"><div class="small">Atraaf today</div><h3 id="kpiATToday">0</h3></div>
                    <div class="card"><div class="small">Total logged</div><h3 id="kpiTotal">0</h3></div>
                </div>
                <div class="divider"></div>
                <canvas id="histPeople" height="260"></canvas>
                <div class="small" style="margin-top:6px">Histogram: per-person counts for FE1, FE2, Atraaf. Itâ€™s basic, but it doesnâ€™t crash in front of guests.</div>
            </div>

            <div class="card shadow cols">
                <div>
                    <p class="panel-title">Assignment history</p>
                    <div class="log">
                        <table id="logTable">
                            <thead>
                                <tr><th>Date/Time</th><th>Type</th><th>Person</th><th>Location</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <p class="panel-title">Data</p>
                    <div class="row" style="gap:8px; flex-wrap:wrap">
                        <button id="btnExport">Export JSON</button>
                        <button id="btnImport">Import JSON</button>
                        <button id="btnReset" style="border-color:var(--bad); color:#ffdada">Reset all</button>
                    </div>
                    <p class="small muted" style="margin-top:10px">Export/Import only affects history; people list persists separately.</p>
                </div>
            </div>
        </aside>
    </main>

    <script>
/* ====== CONFIG & STORAGE ====== */
const DEFAULT_PEOPLE = [
  "SHK MURTAZA BHAI NAGPURWALA",
  "SHK ZOHAIR BHAI INDOREWALA",
  "SHK MURTAZA BHAI MORBIWALA",
  "SHK HUZAIFA BHAI MALINDIWALA",
  "M HAMZA BHAI JASDAN",
  "M TAHA BHAI KAMLAPUR"
];

const LOCATIONS = ["MP Floor","DH Floor","GF","Roof","Haram","Hotel Lobby","Bus"];
const TYPES = ["FE1","FE2","Atraaf"]; // FE split

const LS_PEOPLE = "umrah-atraaf-people-v2";
const LS_LOG    = "umrah-atraaf-log-v2";

let people = loadPeople();
let history = loadLog();

const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ====== TRANSIENT SELECTIONS ====== */
const transient = new Map(); // name -> { type:Set(['FE1','FE2','Atraaf']), location }

/* ====== RENDER PEOPLE LIST ====== */
function renderPeople(){
  const list = $("#peopleList"); list.innerHTML = "";
  people.forEach((name, i)=>{
    const row = document.createElement("div");
    row.className = "person";
    row.dataset.person = name;

    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.innerHTML = `<span class="sr">${String(i+1).padStart(2,"0")}.</span> ${name}
                         <span class="tag small" style="margin-left:6px">${statsBadge(name)}</span>`;

    const fe1 = mkTick("FE1");
    const fe2 = mkTick("FE2");
    const at  = mkTick("Atraaf");

    const loc = document.createElement("select");
    loc.className = "select";
    loc.innerHTML = `<option value="">Select locationâ€¦</option>` + LOCATIONS.map(l=>`<option>${l}</option>`).join("");
    loc.addEventListener("change", ()=>{
      const t = transient.get(name) || {type:new Set(), location:""};
      t.location = loc.value; transient.set(name, t); updatePreview();
    });

    const del = document.createElement("button");
    del.className = "del"; del.textContent = "Delete";
    del.title = "Remove person from list (history remains)";
    del.addEventListener("click", ()=>{
      if (!confirm(`Remove ${name}? History entries will stay.`)) return;
      people = people.filter(p=>p!==name); savePeople(); renderPeople(); renderKPIs(); drawHistogram(); updatePreview();
    });

    row.append(nameDiv, fe1, fe2, at, loc, del);
    list.append(row);

    function mkTick(label){
      const w = document.createElement("label");
      w.className = "switch";
      w.innerHTML = `<input type="checkbox" data-type="${label}" /> <span>${label}</span>`;
      w.querySelector("input").addEventListener("change", e=>{
        const t = transient.get(name) || {type:new Set(), location:""};
        if (e.target.checked) t.type.add(label); else t.type.delete(label);
        transient.set(name, t);
        updatePreview();
      });
      return w;
    }
  });

  // FE1 balance leaderboard chips
  renderFE1Leaderboard();
}

function statsBadge(name){
  const c = countByPerson(name);
  return `FE1:${c.FE1||0} Â· FE2:${c.FE2||0} Â· AT:${c.Atraaf||0}`;
}

/* ====== PREVIEW (SECRET-FRIENDLY) ====== */
function headerText(){
  const title = $("#sessionTitle").value.trim() || "Aaje Raate Haram";
  const dt = ($("#sessionDate").value ? new Date($("#sessionDate").value) : new Date());
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const wk = dt.toLocaleDateString(undefined,{weekday:"long"});
  const hh = String(dt.getHours()).padStart(2,"0");
  const mi = String(dt.getMinutes()).padStart(2,"0");
  return `${title}\n${mm} ${dd} ${wk}${hh+mi!=="0000" ? " " + hh + ":" + mi : ""}\n`;
}

function buildGroups(){
  const groups = {};
  for (const [name, obj] of transient.entries()){
    if (!obj || obj.type.size===0) continue; // must be assigned to something
    const loc = obj.location || "Unassigned";
    (groups[loc] ||= []).push(name);
  }
  for (const k in groups) groups[k].sort((a,b)=>a.localeCompare(b));
  const order = [...LOCATIONS.filter(l=>groups[l]), ...Object.keys(groups).filter(k=>!LOCATIONS.includes(k)).sort()];
  return {groups, order};
}

function updatePreview(){
  const {groups, order} = buildGroups();
  let out = headerText() + "\n";
  for (const k of order){
    out += k + "\n";
    out += (groups[k]||[]).join("\n") + "\n\n";
  }
  $("#preview").textContent = out.trim();
}

/* ====== SAVE ====== */
function saveAssignments(){
  const dt = ($("#sessionDate").value ? new Date($("#sessionDate").value) : new Date()).toISOString();
  let added = 0;

  for (const [name, obj] of transient.entries()){
    if (!obj || obj.type.size===0) continue;
    const loc = obj.location || "";
    for (const t of obj.type){
      history.push({ ts: dt, person: name, type: t, location: loc });
      added++;
    }
  }
  if (!added){ flash("Nothing ticked. Revolutionary to tick first, then save."); return; }
  saveLog(); renderHistory(); renderKPIs(); drawHistogram(); renderPeople();
  $("#btnClearChecks").click();
  flash(`Saved ${added} assignment${added>1?"s":""}.`);
}

/* ====== HISTORY TABLE ====== */
function renderHistory(){
  const tbody = $("#logTable tbody"); tbody.innerHTML = "";
  const sorted = [...history].sort((a,b)=> b.ts.localeCompare(a.ts));
  for (const r of sorted){
    const tr = document.createElement("tr");
    const when = new Date(r.ts).toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    tr.innerHTML = `<td>${when}</td><td>${r.type}</td><td>${r.person}</td><td>${r.location||""}</td>`;
    tbody.append(tr);
  }
}

/* ====== KPIs & STATS ====== */
function renderKPIs(){
  const today = new Date(); const Y=today.getFullYear(), M=today.getMonth(), D=today.getDate();
  const isToday = ts => { const t=new Date(ts); return t.getFullYear()===Y && t.getMonth()===M && t.getDate()===D; };
  $("#kpiFE1Today").textContent = history.filter(h=>h.type==="FE1"    && isToday(h.ts)).length;
  $("#kpiFE2Today").textContent = history.filter(h=>h.type==="FE2"    && isToday(h.ts)).length;
  $("#kpiATToday").textContent  = history.filter(h=>h.type==="Atraaf" && isToday(h.ts)).length;
  $("#kpiTotal").textContent    = history.length;
}

/* ====== FE1 FAIRNESS ====== */
function countByPerson(name){
  const counts = { FE1:0, FE2:0, Atraaf:0, lastFE1:null };
  for (const h of history) if (h.person===name){
    counts[h.type] = (counts[h.type]||0) + 1;
    if (h.type==="FE1") counts.lastFE1 = h.ts;
  }
  return counts;
}

function fe1Order(){
  // asc by FE1 count, then oldest lastFE1 first, then by name
  return people.map(n=>({ name:n, ...countByPerson(n) }))
    .sort((a,b)=>{
      if (a.FE1!==b.FE1) return a.FE1 - b.FE1;
      const ax = a.lastFE1 ? new Date(a.lastFE1).getTime() : 0;
      const bx = b.lastFE1 ? new Date(b.lastFE1).getTime() : 0;
      if (ax!==bx) return ax - bx;
      return a.name.localeCompare(b.name);
    });
}

function renderFE1Leaderboard(){
  const wrap = $("#fe1Leaderboard"); wrap.innerHTML = "";
  fe1Order().forEach((p,i)=>{
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = `${String(i+1).padStart(2,"0")} Â· ${p.name} Â· FE1:${p.FE1} (${p.lastFE1?new Date(p.lastFE1).toLocaleDateString(): "â€”"})`;
    wrap.append(span);
  });
}

$("#btnRecommendFE1").addEventListener("click", ()=>{
  const n = Math.max(1, parseInt($("#recCount").value||"3",10));
  const chosen = fe1Order().slice(0,n).map(p=>p.name);
  // tick FE1 for these, visually mark
  chosen.forEach(name=>{
    const row = $(`.person[data-person="${cssEscape(name)}"]`);
    if (!row) return;
    const cb = row.querySelector('input[data-type="FE1"]');
    cb.checked = true;
    const t = transient.get(name) || {type:new Set(), location:""};
    t.type.add("FE1"); transient.set(name,t);
    row.classList.add("balanced");
    setTimeout(()=>row.classList.remove("balanced"), 1200);
  });
  updatePreview();
});

/* ====== HISTOGRAM (vanilla canvas) ====== */
function drawHistogram(){
  const cv = $("#histPeople"); const ctx = cv.getContext("2d");
  const W = cv.width = cv.clientWidth; const H = cv.height = cv.clientHeight;

  // data
  const rows = people.map(n=>({ name:n, ...countByPerson(n) }));
  const maxV = Math.max(1, ...rows.map(r=>Math.max(r.FE1, r.FE2, r.Atraaf)));
  const padL=80, padR=10, padT=20, padB=30;
  const chartW = W - padL - padR; const chartH = H - padT - padB;

  // clear
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "#0a121a"; ctx.fillRect(0,0,W,H);

  // axes
  ctx.strokeStyle = "#30465a"; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL, H-padB); ctx.lineTo(W-padR, H-padB); ctx.stroke();

  // y grid
  const steps = Math.min(6, maxV);
  for (let i=0;i<=steps;i++){
    const y = H - padB - (i/steps)*chartH;
    ctx.strokeStyle = i===0 ? "#30465a" : "rgba(82,116,140,.35)";
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    ctx.fillStyle = "#7c8c9a"; ctx.font = "12px ui-monospace, monospace";
    ctx.fillText(String(Math.round((i/steps)*maxV)), 8, y+4);
  }

  // bars (grouped: FE1, FE2, Atraaf)
  const n = rows.length;
  const groupW = chartW / Math.max(1,n);
  const barW = Math.min(20, groupW/4);

  rows.forEach((r, idx)=>{
    const x0 = padL + idx*groupW + (groupW - 3*barW)/2;

    const series = [
      {key:"FE1",    val:r.FE1},
      {key:"FE2",    val:r.FE2},
      {key:"Atraaf", val:r.Atraaf}
    ];

    series.forEach((s, j)=>{
      const h = (s.val/maxV) * (chartH-2);
      const x = x0 + j*barW;
      const y = H - padB - h;

      // color by series without hard-coded colors request? fine, default canvas colors are bland; using stroke shades only.
      ctx.fillStyle = j===0 ? "#2e7dd1" : j===1 ? "#23a56b" : "#e3b341";
      ctx.strokeStyle = "#0a0a0a";
      ctx.fillRect(x, y, barW-2, h);
    });

    // labels
    ctx.fillStyle = "#9fb1c4"; ctx.font = "11px system-ui, sans-serif";
    const label = r.name.length>14 ? r.name.slice(0,12)+"â€¦" : r.name;
    ctx.save(); ctx.translate(padL + idx*groupW + groupW/2, H - padB + 12);
    ctx.rotate(-Math.PI/6); ctx.textAlign = "center";
    ctx.fillText(label, 0, 0);
    ctx.restore();
  });
}

/* ====== IMPORT / EXPORT / RESET ====== */
$("#btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(history, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="umrah-atraaf-history.json"; a.click(); URL.revokeObjectURL(url);
});

$("#btnImport").addEventListener("click", ()=>{
  const inp = document.createElement("input"); inp.type="file"; inp.accept="application/json";
  inp.onchange = async e=>{
    const file = e.target.files[0]; if(!file) return;
    let data=[]; try{ data = JSON.parse(await file.text()); }catch{ flash("Invalid JSON. Nice try."); return; }
    const before = history.length;
    const key = r => [r.ts,r.person,r.type,r.location||""].join("|");
    const have = new Set(history.map(key));
    for (const r of data){ if (!r || !r.ts || !r.person || !r.type) continue; if (!have.has(key(r))) history.push(r); }
    saveLog(); renderHistory(); renderKPIs(); drawHistogram(); renderPeople();
    flash(`Imported ${history.length - before} new entries.`);
  };
  inp.click();
});

$("#btnReset").addEventListener("click", ()=>{
  if (!confirm("Wipe ALL saved history and people list?")) return;
  history = []; people = []; saveLog(); savePeople(); renderEverything(); flash("Factory reset. May fortune favor your next decisions.");
});

/* ====== COPY & CLEAR ====== */
$("#btnCopy").addEventListener("click", async ()=>{
  const text = $("#preview").textContent.trim();
  if (!text){ flash("Nothing to copy."); return; }
  try{ await navigator.clipboard.writeText(text); flash("Copied."); }
  catch{
    const ta=document.createElement("textarea"); ta.value=text; document.body.append(ta); ta.select();
    document.execCommand("copy"); ta.remove(); flash("Copied.");
  }
});

$("#btnClearChecks").addEventListener("click", ()=>{
  $$("#peopleList input[type=checkbox]").forEach(cb=>cb.checked=false);
  $$("#peopleList select").forEach(s=>s.selectedIndex = 0);
  transient.clear(); updatePreview();
});

/* ====== ADD PERSON ====== */
$("#btnAddPerson").addEventListener("click", ()=>{
  const name = ($("#newPersonName").value||"").trim();
  if (!name) return flash("Give the human a name.");
  if (people.includes(name)) return flash("Already exists.");
  people.push(name); savePeople(); $("#newPersonName").value=""; renderPeople(); drawHistogram(); updatePreview();
});

/* ====== BUTTON: SAVE ====== */
$("#btnSave").addEventListener("click", saveAssignments);

/* ====== UTIL ====== */
function flash(msg){
  const x = document.createElement("div");
  x.textContent = msg;
  x.style.cssText = "position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#162433; color:#dff6ff; border:1px solid #264459; padding:10px 14px; border-radius:12px; z-index:99";
  document.body.append(x); setTimeout(()=>x.remove(), 2200);
}
function savePeople(){ localStorage.setItem(LS_PEOPLE, JSON.stringify(people)); }
function loadPeople(){
  try{ const v = JSON.parse(localStorage.getItem(LS_PEOPLE)||"null"); return Array.isArray(v)&&v.length ? v : DEFAULT_PEOPLE.slice(); }
  catch{ return DEFAULT_PEOPLE.slice(); }
}
function saveLog(){ localStorage.setItem(LS_LOG, JSON.stringify(history)); }
function loadLog(){ try{ return JSON.parse(localStorage.getItem(LS_LOG)||"[]"); } catch{ return []; } }
function cssEscape(s){ return s.replace(/[^\w-]/g, m=>`\\${m}`); }

/* ====== EXCEL EXPORT (HTML .xls to match your format) ====== */
function fmtShort(dISO){
  const d = new Date(dISO);
  const dd = String(d.getDate()).padStart(2,"0");
  const mon = d.toLocaleString(undefined, { month:"short" });
  return `${dd}-${mon}`;
}
function collectDatesByPerson(typeSet){
  // returns Map(name -> sorted array of dd-Mon strings)
  const m = new Map();
  people.forEach(n=>m.set(n, []));
  for (const r of history){
    if (!typeSet.has(r.type)) continue;
    if (!m.has(r.person)) m.set(r.person, []);
    m.get(r.person).push(fmtShort(r.ts));
  }
  // sort & dedupe
  for (const [k, arr] of m.entries()){
    arr.sort((a,b)=>{
      const pa = Date.parse(a.replace(/-(\w\w\w)$/, " $1 2001")); // month-order fallback
      const pb = Date.parse(b.replace(/-(\w\w\w)$/, " $1 2001"));
      return pa - pb || a.localeCompare(b);
    });
    m.set(k, Array.from(new Set(arr)));
  }
  return m;
}
function buildTableHTML(title, rows, dateColCount){
  const cols = 2 + dateColCount; // SR, NAME, dates...
  const border = "border:1px solid #000;";
  const th = `style="${border} font-weight:bold; text-align:center; padding:4px 6px;"`;
  const td = `style="${border} padding:4px 6px;"`;
  let html = `<table cellspacing="0" cellpadding="0" style="border-collapse:collapse; ${border} width:100%;">`;
  html += `<tr><th ${th} colspan="${cols}" style="${border} font-size:18px; color:#c00000; text-align:center;">${title}</th></tr>`;
  // header row
  html += `<tr><th ${th}>SR NO.</th><th ${th}>NAME</th>`;
  for(let i=0;i<dateColCount;i++) html += `<th ${th}>DATE</th>`;
  html += `</tr>`;
  // body
  let sr = 1;
  for (const [name, dates] of rows){
    html += `<tr><td ${td} style="text-align:center;">${sr++}</td><td ${td}>${name}</td>`;
    for(let i=0;i<dateColCount;i++){
      html += `<td ${td}>${dates[i] || ""}</td>`;
    }
    html += `</tr>`;
  }
  html += `</table>`;
  return html;
}
function exportExcelLikeSheet(){
  // FE1 + FE2 under FAKKUL
  const feMap = collectDatesByPerson(new Set(["FE1","FE2"]));
  const atMap = collectDatesByPerson(new Set(["Atraaf"]));

  // keep the order of current "people" list
  const feRows = people.map(n => [n, feMap.get(n) || []]);
  const atRows = people.map(n => [n, atMap.get(n) || []]);

  const feMaxCols = Math.max(0, ...feRows.map(r=>r[1].length), 14); // default to 14 DATE cols like your image
  const atMaxCols = Math.max(0, ...atRows.map(r=>r[1].length), 14);

  const headNote = `
    <div style="font-family:Calibri,Arial; font-size:12px; margin:6px 0 10px;">
      <div><strong>Session:</strong> ${($("#sessionTitle").value||"").trim() || "â€”"} | <strong>Date:</strong> ${($("#sessionDate").value ? new Date($("#sessionDate").value).toLocaleString() : new Date().toLocaleString())}</div>
    </div>
  `;

  const feTable = buildTableHTML("FAKKUL EHRAAM", feRows, feMaxCols);
  const atTable = buildTableHTML("ATRAAF", atRows, atMaxCols);

  const doc = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:x="urn:schemas-microsoft-com:office:excel"
          xmlns="http://www.w3.org/TR/REC-html40">
    <head>
      <meta charset="utf-8" />
      <!-- This HTML is intentionally Excel-friendly. Yes, Excel will open it like a champ. -->
    </head>
    <body>
      ${headNote}
      ${feTable}
      <div style="height:16px"></div>
      ${atTable}
    </body>
    </html>
  `;
  const blob = new Blob([doc], {type: "application/vnd.ms-excel"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Assignments_FE_AT.xls";
  a.click();
  URL.revokeObjectURL(url);
}

/* wire up the new button */
document.getElementById("btnExportExcel").addEventListener("click", exportExcelLikeSheet);


/* ====== INIT ====== */
(function init(){
  const now = new Date(); now.setMinutes(now.getMinutes() - (now.getMinutes()%5), 0, 0);
  $("#sessionDate").value = new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  renderEverything();
})();
function renderEverything(){
  renderPeople(); renderHistory(); renderKPIs(); drawHistogram(); updatePreview();
}
    </script>
</body>
</html>
