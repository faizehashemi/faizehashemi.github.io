<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PMS ‚Äî Check-ins & Check-outs</title>
<style>
  :root{
    --ink:#0b1220; --muted:#64748b; --card:#ffffff; --border:#e5e7eb; --accent:#0f766e;
    --shadow:0 10px 28px rgba(2,6,23,.08);
    --chip:#ecfeff;
  }
  @media (prefers-color-scheme: dark){
    :root{ --ink:#e5e7eb; --muted:#9aa4b2; --card:#0f1216; --border:#1f2937; --accent:#22d3ee; --shadow:none; --chip:#062e2e; }
  }
  *{box-sizing:border-box}
  body{margin:0;font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f7fafc,#fff);color:var(--ink)}
  .wrap{max-width:1200px;margin:22px auto;padding:0 14px 40px}
  header.hero{background:linear-gradient(0deg,rgba(15,118,110,.10),rgba(15,118,110,.06));border-radius:16px;padding:14px;box-shadow:var(--shadow);border:1px solid var(--border)}
  h1{margin:0 0 6px}
  .muted{color:var(--muted)}
  .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end;margin-top:10px}
  .controls .col{display:flex;flex-direction:column;gap:6px}
  .controls .col-3{grid-column: span 3}
  .controls .col-2{grid-column: span 2}
  .controls .col-4{grid-column: span 4}
  @media (max-width:900px){
    .controls{grid-template-columns:repeat(6,1fr)}
    .controls .col-3{grid-column: span 3}
    .controls .col-2{grid-column: span 3}
    .controls .col-4{grid-column: span 6}
  }
  input[type="date"],input[type="time"],select,button{font:inherit}
  input[type="date"],input[type="time"],select{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff0;color:var(--ink)}
  button{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
  button.primary{border-color:#99f6e4;background:linear-gradient(0deg,rgba(34,211,238,.12),rgba(34,211,238,.12))}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:var(--card);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
  .chip:hover{background:var(--chip)}
  .grid{display:grid;gap:12px;margin-top:14px}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .panel h3{margin:0 0 6px;display:flex;justify-content:space-between;align-items:center}
  .panel .toolbar{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px;vertical-align:top}
  th{background:rgba(15,118,110,.08);text-align:left}
  .right{text-align:right}
  .nowrap{white-space:nowrap}
  .status{margin-top:8px;color:var(--muted)}
</style>
</head>
<body>
    <!-- ==== Background: put this once per page ==== -->
    <style>
         .pms-bg {
             position: fixed;
             inset: 0;
             z-index: -2;
             background: center/cover no-repeat url("bg.png");
             /* Remove blur if you hate nice things */
             filter: saturate(105%) brightness(0.98);
         }

             .pms-bg::after {
                 content: "";
                 position: absolute;
                 inset: 0;
                 z-index: -1;
                 background: radial-gradient(1200px 700px at 50% -10%, rgba(0,0,0,.05), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,0) 40%, rgba(0,0,0,.10));
                 pointer-events: none;
             }
         /* If you need extra contrast for text-heavy pages, uncomment:
        body { background: rgba(255,255,255,.85); backdrop-filter: blur(2px); }
        */
    </style>
    <div class="pms-bg" aria-hidden="true"></div>

    <!-- ===== Minimal Navbar (centered + emoji) ===== -->
    <nav class="min-nav" role="navigation" aria-label="Primary">
        <a href="index.html" aria-label="Home"><span class="e" aria-hidden="true">üè†</span><span>Home</span></a>
        <a href="accommodation_slip.html" aria-label="Slip"><span class="e" aria-hidden="true">üìù</span><span>Slip</span></a>
        <a href="vacancy_forecast.html" aria-label="Forecast"><span class="e" aria-hidden="true">üìà</span><span>Forecast</span></a>
        <a href="building_legend_grid.html" aria-label="Legend Grid"><span class="e" aria-hidden="true">üß©</span><span>Legend Grid</span></a>
        <a href="checkins_checkouts.html" aria-label="Checkins and Checkouts"><span class="e" aria-hidden="true">üóìÔ∏è</span><span>Checkins/Checkouts</span></a>
        <a href="print_slip_a5.html" aria-label="Print"><span class="e" aria-hidden="true">üñ®Ô∏è</span><span>Print</span></a>
        <a href="slip_admin.html" aria-label="Admin"><span class="e" aria-hidden="true">üóÑÔ∏è</span><span>Admin</span></a>
        <a href="pms_instructions.html" aria-label="Instructions"><span class="e" aria-hidden="true">üìñ</span><span>Instructions</span></a>
    </nav>

    <style>
        .min-nav {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center; /* centered */
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255,255,255,.75);
            backdrop-filter: blur(6px);
        }

            .min-nav a {
                display: inline-flex;
                align-items: center;
                gap: 6px; /* emoji + text */
                color: #0b1220;
                text-decoration: none;
                padding: 6px 10px;
                border-radius: 10px;
            }

                .min-nav a:hover {
                    text-decoration: underline
                }

                .min-nav a[aria-current="page"] {
                    font-weight: 700;
                    background: #f3f4f6;
                }

            .min-nav .e {
                font-size: 1.05em;
                line-height: 1
            }
        /* emojis aligned nicely */

        @media (prefers-color-scheme: dark) {
            .min-nav {
                background: rgba(15,18,22,.6);
                border-color: #1f2937
            }

                .min-nav a {
                    color: #e5e7eb
                }

                    .min-nav a[aria-current="page"] {
                        background: #0f172a
                    }
        }
    </style>

    <script>
        (function () {
            var here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
            document.querySelectorAll('.min-nav a').forEach(function (a) {
                if ((a.getAttribute('href') || '').toLowerCase() === here) {
                    a.setAttribute('aria-current', 'page');
                }
            });
        })();
    </script>
    <!-- ===== /Minimal Navbar ===== -->

    <div class="wrap">
        <header class="hero">
            <h1>Check-ins & Check-outs</h1>
            <p class="muted">Filter by single day or a date/time range. Results are read-only and pulled from your local IndexedDB.</p>

            <div class="controls">
                <div class="col col-3">
                    <label for="dateFrom" class="muted">Date from</label>
                    <input id="dateFrom" type="date">
                </div>
                <div class="col col-3">
                    <label for="dateTo" class="muted">Date to</label>
                    <input id="dateTo" type="date">
                </div>
                <div class="col col-2">
                    <label for="timeFrom" class="muted">Time from</label>
                    <input id="timeFrom" type="time" step="60" value="00:00">
                </div>
                <div class="col col-2">
                    <label for="timeTo" class="muted">Time to</label>
                    <input id="timeTo" type="time" step="60" value="23:59">
                </div>
                <div class="col col-2">
                    <label for="mode" class="muted">Mode</label>
                    <select id="mode">
                        <option value="both">Both</option>
                        <option value="in">Check-ins</option>
                        <option value="out">Check-outs</option>
                    </select>
                </div>
                <div class="col col-4">
                    <label class="muted">Quick</label>
                    <div class="chips">
                        <button class="chip" id="presetToday">Today</button>
                        <button class="chip" id="presetYesterday">Yesterday</button>
                        <button class="chip" id="preset7">Last 7 days</button>
                        <button class="chip" id="preset30">Last 30 days</button>
                    </div>
                </div>
                <div class="col col-4">
                    <label class="muted">Actions</label>
                    <div class="chips">
                        <button id="btnRefresh">Refresh DB</button>
                        <button id="btnRun" class="primary">Run</button>
                    </div>
                </div>
            </div>
        </header>

        <section class="grid">
            <div class="panel" id="panelIn" hidden>
                <h3>
                    <span>Check-ins</span>
                    <span class="toolbar">
                        <span class="muted" id="sumIn">0 slips ‚Ä¢ 0 guests</span>
                        <button id="csvIn">Export CSV</button>
                    </span>
                </h3>
                <table id="tblIn">
                    <thead>
                        <tr>
                            <th class="nowrap">Check-in</th>
                            <th>SH No</th>
                            <th>Group</th>
                            <th>Building</th>
                            <th>Rooms</th>
                            <th class="right">Guests</th>
                            <th class="right">G</th>
                            <th class="right">L</th>
                            <th class="right">C</th>
                            <th class="right">I</th>
                            <th class="nowrap">Check-out</th>
                            <th class="right">Nights</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="panel" id="panelOut" hidden>
                <h3>
                    <span>Check-outs</span>
                    <span class="toolbar">
                        <span class="muted" id="sumOut">0 slips ‚Ä¢ 0 guests</span>
                        <button id="csvOut">Export CSV</button>
                    </span>
                </h3>
                <table id="tblOut">
                    <thead>
                        <tr>
                            <th class="nowrap">Check-out</th>
                            <th>SH No</th>
                            <th>Group</th>
                            <th>Building</th>
                            <th>Rooms</th>
                            <th class="right">Guests</th>
                            <th class="right">G</th>
                            <th class="right">L</th>
                            <th class="right">C</th>
                            <th class="right">I</th>
                            <th class="nowrap">Check-in</th>
                            <th class="right">Nights</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <p class="status" id="status">Loading DB‚Ä¶</p>
    </div>

    <script>
        /* ===== DB plumbing ===== */
        const DB_NAME = 'pms_accommodation_db', STORE = 'slips', DB_VERSION = 2;
        function openDB() {
            return new Promise((res, rej) => {
                const r = indexedDB.open(DB_NAME, DB_VERSION);
                r.onupgradeneeded = e => {
                    const db = e.target.result; let s = db.objectStoreNames.contains(STORE) ? e.target.transaction.objectStore(STORE) : db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
                    if (!s.indexNames.contains('createdAt')) s.createIndex('createdAt', 'createdAt', { unique: false });
                    if (!s.indexNames.contains('sh_no')) s.createIndex('sh_no', 'sh_no', { unique: false });
                    if (!s.indexNames.contains('building')) s.createIndex('building', 'building', { unique: false });
                };
                r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error);
            });
        }
        async function getAllRecords() { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE, 'readonly'); const st = tx.objectStore(STORE); const rq = st.getAll(); rq.onsuccess = () => res(rq.result || []); rq.onerror = () => rej(rq.error); tx.oncomplete = () => db.close(); }); }

        /* ===== Helpers ===== */
        function $(id) { return document.getElementById(id) }
        function pad(n) { return String(n).padStart(2, '0') }
        function parseDT(d, t) { if (!d) return null; const tt = t && t.length ? t : '00:00'; const v = new Date(`${d}T${tt}`); return isNaN(v) ? null : v; }
        function ymd(d) { return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}` }
        function roomsFromSlip(r) { const bag = []; (r.rooms?.gents || []).forEach(x => bag.push(String(x.room_no || '').trim())); (r.rooms?.ladies || []).forEach(x => bag.push(String(x.room_no || '').trim())); return Array.from(new Set(bag.filter(Boolean))); }
        function guests(r) { const n = v => Number(v) || 0; return (Number(r.total) || 0) || (n(r.gents) + n(r.ladies) + n(r.children) + n(r.infants)); }
        function nights(r) { const ci = parseDT(r.checkin_date, r.checkin_time), co = parseDT(r.checkout_date, r.checkout_time); if (!ci || !co) return ''; const ms = co - ci; return Math.max(0, Math.round(ms / 86400000)); }
        function fmtDT(dt) { if (!dt) return ''; try { return dt.toLocaleString([], { year: '2-digit', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) } catch (e) { return dt.toISOString().slice(0, 16).replace('T', ' ') } }
        function within(dt, start, end) { return dt && dt >= start && dt <= end; }

        let CACHE = [];

        /* ===== Render ===== */
        function run() {
            const df = $('dateFrom').value, dt = $('dateTo').value;
            const tf = $('timeFrom').value || '00:00', tt = $('timeTo').value || '23:59';
            if (!df || !dt) { alert('Pick both Date from and Date to.'); return; }
            const start = new Date(`${df}T${tf}`);
            const end = new Date(`${dt}T${tt}`);
            if (isNaN(start) || isNaN(end) || end < start) { alert('Invalid range.'); return; }

            const mode = $('mode').value;

            const ins = [], outs = [];
            for (const r of CACHE) {
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                if (ci && within(ci, start, end)) ins.push(r);
                if (co && within(co, start, end)) outs.push(r);
            }

            // Sort by the relevant datetime
            ins.sort((a, b) => parseDT(a.checkin_date, a.checkin_time) - parseDT(b.checkin_date, b.checkin_time));
            outs.sort((a, b) => parseDT(a.checkout_date, a.checkout_time) - parseDT(b.checkout_date, b.checkout_time));

            // Render
            renderTable('In', ins, 'checkin');
            renderTable('Out', outs, 'checkout');

            $('panelIn').hidden = !(mode === 'in' || mode === 'both');
            $('panelOut').hidden = !(mode === 'out' || mode === 'both');

            const totalGuestsIn = ins.reduce((s, r) => s + guests(r), 0);
            const totalGuestsOut = outs.reduce((s, r) => s + guests(r), 0);
            $('sumIn').textContent = `${ins.length} slips ‚Ä¢ ${totalGuestsIn} guests`;
            $('sumOut').textContent = `${outs.length} slips ‚Ä¢ ${totalGuestsOut} guests`;

            $('status').textContent = `Range ${df} ${tf} ‚Üí ${dt} ${tt} ‚Ä¢ ${CACHE.length} slip(s) in DB`;
        }

        function renderTable(kind, rows, key) {
            const tbody = $(`tbl${kind}`).querySelector('tbody');
            tbody.innerHTML = '';
            for (const r of rows) {
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                const t = key === 'checkin' ? fmtDT(ci) : fmtDT(co);
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="nowrap">${t}</td>
          <td>${escapeHTML(r.sh_no || '')}</td>
          <td>${escapeHTML(r.tour_name || '')}</td>
          <td>${escapeHTML((r.building || '').trim())}</td>
          <td>${escapeHTML(roomsFromSlip(r).join(', '))}</td>
          <td class="right">${guests(r)}</td>
          <td class="right">${Number(r.gents) || 0}</td>
          <td class="right">${Number(r.ladies) || 0}</td>
          <td class="right">${Number(r.children) || 0}</td>
          <td class="right">${Number(r.infants) || 0}</td>
          <td class="nowrap">${key === 'checkin' ? fmtDT(co) : fmtDT(ci)}</td>
          <td class="right">${nights(r)}</td>
        `;
                tbody.appendChild(tr);
            }
        }

        function escapeHTML(s) { return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])) }

        /* ===== CSV export ===== */
        function toCSV(rows, kind) {
            const head = kind === 'in'
                ? ['Check-in', 'SH No', 'Group', 'Building', 'Rooms', 'Guests', 'G', 'L', 'C', 'I', 'Check-out', 'Nights']
                : ['Check-out', 'SH No', 'Group', 'Building', 'Rooms', 'Guests', 'G', 'L', 'C', 'I', 'Check-in', 'Nights'];
            const sep = ',';
            const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
            const lines = [head.join(sep)];
            for (const r of rows) {
                const ci = parseDT(r.checkin_date, r.checkin_time);
                const co = parseDT(r.checkout_date, r.checkout_time);
                const row = kind === 'in'
                    ? [fmtDT(ci), r.sh_no || '', r.tour_name || '', (r.building || '').trim(), roomsFromSlip(r).join(' '), guests(r), Number(r.gents) || 0, Number(r.ladies) || 0, Number(r.children) || 0, Number(r.infants) || 0, fmtDT(co), nights(r)]
                    : [fmtDT(co), r.sh_no || '', r.tour_name || '', (r.building || '').trim(), roomsFromSlip(r).join(' '), guests(r), Number(r.gents) || 0, Number(r.ladies) || 0, Number(r.children) || 0, Number(r.infants) || 0, fmtDT(ci), nights(r)];
                lines.push(row.map(esc).join(sep));
            }
            return lines.join('\r\n');
        }
        function downloadCSV(text, filename) {
            const blob = new Blob([text], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        /* ===== Boot ===== */
        async function refresh() {
            try {
                CACHE = await getAllRecords();
                const now = new Date();
                const today = ymd(now);
                $('dateFrom').value = today;
                $('dateTo').value = today;
                run();
            } catch (e) {
                console.error(e);
                $('status').textContent = 'Could not open local DB (IndexedDB blocked?).';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            $('btnRefresh').addEventListener('click', refresh);
            $('btnRun').addEventListener('click', run);
            $('presetToday').addEventListener('click', () => {
                const now = new Date(); const t = ymd(now); $('dateFrom').value = t; $('dateTo').value = t; $('timeFrom').value = '00:00'; $('timeTo').value = '23:59'; run();
            });
            $('presetYesterday').addEventListener('click', () => {
                const d = new Date(); d.setDate(d.getDate() - 1); const y = ymd(d); $('dateFrom').value = y; $('dateTo').value = y; $('timeFrom').value = '00:00'; $('timeTo').value = '23:59'; run();
            });
            $('preset7').addEventListener('click', () => {
                const d = new Date(); const to = ymd(d); d.setDate(d.getDate() - 6); $('dateFrom').value = ymd(d); $('dateTo').value = to; run();
            });
            $('preset30').addEventListener('click', () => {
                const d = new Date(); const to = ymd(d); d.setDate(d.getDate() - 29); $('dateFrom').value = ymd(d); $('dateTo').value = to; run();
            });
            $('csvIn').addEventListener('click', () => {
                const df = $('dateFrom').value, dt = $('dateTo').value, tf = $('timeFrom').value || '00:00', tt = $('timeTo').value || '23:59';
                const start = new Date(`${df}T${tf}`), end = new Date(`${dt}T${tt}`);
                const rows = CACHE.filter(r => { const ci = parseDT(r.checkin_date, r.checkin_time); return ci && ci >= start && ci <= end; }).sort((a, b) => parseDT(a.checkin_date, a.checkin_time) - parseDT(b.checkin_date, b.checkin_time));
                downloadCSV(toCSV(rows, 'in'), `checkins_${df}_${dt}.csv`);
            });
            $('csvOut').addEventListener('click', () => {
                const df = $('dateFrom').value, dt = $('dateTo').value, tf = $('timeFrom').value || '00:00', tt = $('timeTo').value || '23:59';
                const start = new Date(`${df}T${tf}`), end = new Date(`${dt}T${tt}`);
                const rows = CACHE.filter(r => { const co = parseDT(r.checkout_date, r.checkout_time); return co && co >= start && co <= end; }).sort((a, b) => parseDT(a.checkout_date, a.checkout_time) - parseDT(b.checkout_date, b.checkout_time));
                downloadCSV(toCSV(rows, 'out'), `checkouts_${df}_${dt}.csv`);
            });
            refresh();
        });
    </script>
</body>
</html>
